<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#4f46e5">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>Yahtzee Scorer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #312e81 0%, #581c87 50%, #831843 100%); min-height: 100vh; }
    .container { max-width: 28rem; margin: 0 auto; padding: 1rem; }
    .text-center { text-align: center; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mt-4 { margin-top: 1rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-5 { padding: 1.25rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .py-5 { padding-top: 1.25rem; padding-bottom: 1.25rem; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .flex { display: flex; }
    .flex-1 { flex: 1; }
    .w-full { width: 100%; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .grid { display: grid; }
    .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-cols-6 { grid-template-columns: repeat(6, 1fr); }
    .space-y-2 > * + * { margin-top: 0.5rem; }
    .space-y-3 > * + * { margin-top: 0.75rem; }
    .overflow-x-auto { overflow-x: auto; }
    .whitespace-nowrap { white-space: nowrap; }
    .flex-shrink-0 { flex-shrink: 0; }
    
    .rounded-lg { border-radius: 0.5rem; }
    .rounded-xl { border-radius: 0.75rem; }
    .rounded-2xl { border-radius: 1rem; }
    .rounded-full { border-radius: 9999px; }
    
    .text-xs { font-size: 0.75rem; }
    .text-sm { font-size: 0.875rem; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .text-4xl { font-size: 2.25rem; }
    .text-5xl { font-size: 3rem; }
    .font-medium { font-weight: 500; }
    .font-bold { font-weight: 700; }
    .font-black { font-weight: 900; }
    
    .text-white { color: white; }
    .text-gray-400 { color: #9ca3af; }
    .text-gray-500 { color: #6b7280; }
    .text-gray-600 { color: #4b5563; }
    .text-gray-800 { color: #1f2937; }
    .text-purple-200 { color: #e9d5ff; }
    .text-purple-600 { color: #9333ea; }
    .text-purple-700 { color: #7c3aed; }
    .text-blue-600 { color: #2563eb; }
    .text-blue-700 { color: #1d4ed8; }
    .text-blue-800 { color: #1e40af; }
    .text-green-600 { color: #16a34a; }
    .text-green-700 { color: #15803d; }
    .text-red-400 { color: #f87171; }
    .text-red-500 { color: #ef4444; }
    .text-yellow-400 { color: #facc15; }
    .text-yellow-600 { color: #ca8a04; }
    .text-yellow-800 { color: #854d0e; }
    
    .glass { background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
    .glass-dark { background: rgba(255,255,255,0.25); }
    
    .shadow-md { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
    
    /* Base button - NO background defined here */
    .btn { 
      border: none; 
      cursor: pointer; 
      transition: all 0.15s; 
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn:active { transform: scale(0.95); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    /* Text-only button (transparent background) */
    .btn-text {
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-text:active { transform: scale(0.95); opacity: 0.7; }
    
    /* Primary action button */
    .btn-primary { 
      background: linear-gradient(to right, #22c55e, #059669); 
      color: white; 
      font-weight: 900; 
      padding: 1.25rem; 
      border-radius: 1rem; 
      font-size: 1.25rem; 
      width: 100%; 
    }
    
    /* Resume game button */
    .btn-resume {
      background: linear-gradient(to right, #f97316, #ea580c);
      color: white;
      font-weight: 900;
      padding: 1.25rem;
      border-radius: 1rem;
      font-size: 1.25rem;
      width: 100%;
    }
    
    /* Secondary button */
    .btn-secondary { 
      background: rgba(255,255,255,0.1); 
      color: white; 
      font-weight: 700; 
      padding: 1rem; 
      border-radius: 0.75rem; 
      width: 100%; 
      border: 1px solid rgba(255,255,255,0.1); 
    }
    
    /* Small button base */
    .btn-small { 
      padding: 0.5rem 0.75rem; 
      font-size: 0.875rem; 
      border-radius: 0.5rem; 
      font-weight: 600; 
    }
    
    /* Colored buttons - used in modals */
    .btn-blue {
      background-color: #2563eb;
      color: white;
    }
    .btn-green {
      background-color: #22c55e;
      color: white;
    }
    .btn-purple {
      background-color: #a855f7;
      color: white;
    }
    .btn-orange {
      background-color: #f97316;
      color: white;
    }
    .btn-yellow {
      background-color: #eab308;
      color: white;
    }
    .btn-gray {
      background-color: #f3f4f6;
      color: #6b7280;
    }
    .btn-gray-dark {
      background-color: #e5e7eb;
      color: #9ca3af;
    }
    
    .input { 
      border: 2px solid #e5e7eb; 
      border-radius: 0.75rem; 
      padding: 0.75rem 1rem; 
      font-size: 1rem; 
      width: 100%; 
      font-family: inherit;
      background: white;
    }
    .input:focus { outline: none; border-color: #3b82f6; }
    
    .card { 
      background: white; 
      border-radius: 1rem; 
      box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); 
      overflow: hidden; 
    }
    
    .header-gradient { background: linear-gradient(to right, #4f46e5, #9333ea); }
    .upper-gradient { background: linear-gradient(to right, #3b82f6, #2563eb); }
    .lower-gradient { background: linear-gradient(to right, #9333ea, #7c3aed); }
    .total-gradient { background: linear-gradient(to right, #4f46e5, #9333ea); }
    
    .modal-overlay { 
      position: fixed; 
      inset: 0; 
      background: rgba(0,0,0,0.5); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 50; 
      padding: 1rem; 
    }
    .modal { 
      background: white; 
      border-radius: 1rem; 
      padding: 1.25rem; 
      width: 100%; 
      max-width: 24rem; 
      max-height: 80vh; 
      overflow: auto; 
    }
    
    .color-dot { width: 1rem; height: 1rem; border-radius: 9999px; flex-shrink: 0; }
    .color-dot-sm { width: 0.75rem; height: 0.75rem; border-radius: 9999px; flex-shrink: 0; }
    
    .checkbox { 
      width: 1.25rem; 
      height: 1.25rem; 
      border-radius: 9999px; 
      border: 2px solid white; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      flex-shrink: 0; 
    }
    .checkbox-inner { width: 0.75rem; height: 0.75rem; border-radius: 9999px; background: white; }
    
    .score-btn { 
      min-width: 4rem; 
      padding: 0.5rem 1rem; 
      border-radius: 0.75rem; 
      font-weight: 700; 
      font-size: 1.125rem; 
      border: none; 
      cursor: pointer; 
      transition: all 0.15s;
      font-family: inherit;
    }
    .score-btn:active { transform: scale(0.95); }
    .score-filled-blue { background-color: #dbeafe; color: #1d4ed8; }
    .score-filled-purple { background-color: #f3e8ff; color: #7c3aed; }
    .score-empty { background-color: #f3f4f6; color: #9ca3af; border: 2px dashed #d1d5db; }
    
    .picker-btn { 
      background-color: #eff6ff; 
      border: none; 
      border-radius: 0.75rem; 
      padding: 0.75rem; 
      cursor: pointer; 
      transition: all 0.15s;
      font-family: inherit;
    }
    .picker-btn:active { background-color: #dbeafe; transform: scale(0.95); }
    .picker-btn-green { 
      background-color: #f0fdf4; 
      border: 2px solid #bbf7d0; 
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .picker-btn-green:active { background-color: #dcfce7; transform: scale(0.95); }
    .picker-btn-red { 
      background-color: #fef2f2; 
      border: 2px solid #fecaca; 
      border-radius: 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .picker-btn-red:active { background-color: #fee2e2; transform: scale(0.95); }
    .picker-btn-purple { 
      background-color: #faf5ff; 
      border: none; 
      border-radius: 0.5rem; 
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .picker-btn-purple:active { background-color: #f3e8ff; transform: scale(0.95); }
    
    .player-tab { 
      padding: 0.5rem 1rem; 
      border-radius: 9999px; 
      font-size: 0.875rem; 
      font-weight: 700; 
      white-space: nowrap; 
      border: none; 
      cursor: pointer; 
      transition: all 0.15s;
      font-family: inherit;
    }
    .player-tab:active { transform: scale(0.95); }
    .player-tab-active { color: white; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
    .player-tab-inactive { background-color: #f3f4f6; color: #4b5563; }
    
    .standing-bar { 
      height: 2.5rem; 
      border-radius: 0.75rem; 
      display: flex; 
      align-items: center; 
      padding: 0 0.75rem; 
      color: white; 
      font-weight: 700; 
      font-size: 0.875rem; 
      transition: width 0.5s; 
    }
    
    .divider { height: 1px; background-color: #f3f4f6; }
    
    .sticky { position: sticky; top: 0; z-index: 20; }
    .sticky-tabs { position: sticky; top: 2.75rem; z-index: 10; }
    
    /* Small transparent action buttons */
    .clear-btn {
      background: transparent;
      border: none;
      color: #f87171;
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      font-family: inherit;
      line-height: 1;
    }
    .clear-btn:active { transform: scale(0.9); }
    
    .order-btn {
      background: transparent;
      border: none;
      color: white;
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      font-family: inherit;
      line-height: 1;
    }
    .order-btn:active { transform: scale(0.9); }
    
    .delete-btn {
      background: transparent;
      border: none;
      color: #f87171;
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      font-family: inherit;
      font-weight: 500;
    }
    .delete-btn:active { transform: scale(0.9); opacity: 0.7; }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      font-weight: 600;
      z-index: 100;
      animation: toast-in 0.3s ease, toast-out 0.3s ease 1.7s forwards;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(-50%) translateY(1rem); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateX(-50%) translateY(0); }
      to { opacity: 0; transform: translateX(-50%) translateY(1rem); }
    }
    
    /* Current turn indicator */
    .current-turn-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    .pulse-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: #4ade80;
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* Version footer */
    .version-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      text-align: center;
      padding: 0.25rem 0.5rem;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      font-size: 0.625rem;
      color: rgba(255, 255, 255, 0.5);
      z-index: 1000;
      font-family: monospace;
    }
    .version-footer:hover {
      color: rgba(255, 255, 255, 0.8);
    }

    /* Mode toggle styles */
    .mode-toggle {
      display: flex;
      background: rgba(255,255,255,0.1);
      border-radius: 0.75rem;
      padding: 0.25rem;
      margin-bottom: 1rem;
    }
    .mode-btn {
      flex: 1;
      padding: 0.75rem;
      border: none;
      background: transparent;
      color: rgba(255,255,255,0.6);
      font-weight: 700;
      font-size: 0.875rem;
      cursor: pointer;
      border-radius: 0.5rem;
      transition: all 0.2s;
      font-family: inherit;
    }
    .mode-btn.active {
      background: white;
      color: #4f46e5;
    }

    /* Dice styles */
    .dice-area {
      background: linear-gradient(135deg, #1e1b4b 0%, #312e81 100%);
      border-radius: 1rem;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .dice-container {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .die {
      width: 3.5rem;
      height: 3.5rem;
      background: white;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      font-weight: 900;
      color: #1f2937;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .die:active {
      transform: scale(0.95);
    }
    .die.held {
      background: #fef3c7;
      border: 3px solid #f59e0b;
      box-shadow: 0 0 12px rgba(245, 158, 11, 0.5);
    }
    .die.held::after {
      content: 'HOLD';
      position: absolute;
      bottom: -1.25rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.625rem;
      font-weight: 700;
      color: #f59e0b;
      white-space: nowrap;
    }
    .die.rolling {
      animation: dice-roll 0.1s ease-in-out infinite;
    }
    @keyframes dice-roll {
      0% { transform: rotate(-5deg) scale(1.05); }
      50% { transform: rotate(5deg) scale(0.95); }
      100% { transform: rotate(-5deg) scale(1.05); }
    }
    .roll-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(to right, #22c55e, #16a34a);
      color: white;
      border: none;
      border-radius: 0.75rem;
      font-size: 1.125rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .roll-btn:active {
      transform: scale(0.98);
    }
    .roll-btn:disabled {
      background: #9ca3af;
      cursor: not-allowed;
      transform: none;
    }
    .roll-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
      color: white;
    }
    .roll-count {
      font-weight: 700;
      font-size: 1rem;
    }
    .shake-hint {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    /* Score suggestion styles */
    .score-suggestion {
      background: #dcfce7;
      border: 2px solid #22c55e;
    }
    .score-suggestion-text {
      color: #16a34a;
      font-weight: 700;
      font-size: 0.75rem;
    }

    /* Play mode category button */
    .score-btn-play {
      min-width: 4rem;
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      font-weight: 700;
      font-size: 1.125rem;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .score-btn-play:active {
      transform: scale(0.95);
    }
    .score-btn-play:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .score-available {
      background: #dcfce7;
      color: #16a34a;
      border: 2px solid #22c55e;
    }
    .score-zero-only {
      background: #fee2e2;
      color: #ef4444;
      border: 2px dashed #fca5a5;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="toast"></div>
  <div id="version" class="version-footer">v1.0.0</div>

  <script>
    // Automatic version management via git hooks
    const UPPER = [
      { id: 'ones', name: 'Ones', value: 1 },
      { id: 'twos', name: 'Twos', value: 2 },
      { id: 'threes', name: 'Threes', value: 3 },
      { id: 'fours', name: 'Fours', value: 4 },
      { id: 'fives', name: 'Fives', value: 5 },
      { id: 'sixes', name: 'Sixes', value: 6 },
    ];

    const LOWER = [
      { id: 'threeOfKind', name: '3 of a Kind', type: 'sum', max: 30 },
      { id: 'fourOfKind', name: '4 of a Kind', type: 'sum', max: 30 },
      { id: 'fullHouse', name: 'Full House', type: 'fixed', fixed: 25 },
      { id: 'smallStraight', name: 'Sm. Straight', type: 'fixed', fixed: 30 },
      { id: 'largeStraight', name: 'Lg. Straight', type: 'fixed', fixed: 40 },
      { id: 'yahtzee', name: 'YAHTZEE!', type: 'fixed', fixed: 50 },
      { id: 'chance', name: 'Chance', type: 'sum', max: 30 },
    ];

    const COLORS = ['#3b82f6','#ef4444','#22c55e','#f59e0b','#8b5cf6','#ec4899','#06b6d4','#f97316'];

    let S = {
      view: 'setup',
      known: JSON.parse(localStorage.getItem('yahtzeeP') || '[]'),
      game: [],
      cur: 0,
      history: JSON.parse(localStorage.getItem('yahtzeeH') || '[]'),
      savedGame: JSON.parse(localStorage.getItem('yahtzeeSaved') || 'null'),
      start: null,
      picker: null,
      mgr: false,
      stats: null,
      // Game mode: 'score' (manual entry) or 'play' (with dice)
      mode: 'score',
      // Dice state for play mode
      dice: [1, 1, 1, 1, 1],
      held: [false, false, false, false, false],
      rollCount: 0,
      rolling: false,
      turnStarted: false, // Must tap "Start Turn" before rolling
      // Shake detection
      shakeEnabled: false,
      lastShake: 0
    };

    const save = () => { 
      localStorage.setItem('yahtzeeP', JSON.stringify(S.known)); 
      localStorage.setItem('yahtzeeH', JSON.stringify(S.history)); 
    };
    
    const saveCurrentGame = () => {
      const gameState = {
        game: S.game,
        cur: S.cur,
        start: S.start,
        savedAt: Date.now(),
        // Save play mode state
        mode: S.mode,
        dice: S.dice,
        held: S.held,
        rollCount: S.rollCount,
        turnStarted: S.turnStarted
      };
      localStorage.setItem('yahtzeeSaved', JSON.stringify(gameState));
      S.savedGame = gameState;
    };
    
    const clearSavedGame = () => {
      localStorage.removeItem('yahtzeeSaved');
      S.savedGame = null;
    };
    
    const empty = () => ({ ones:null, twos:null, threes:null, fours:null, fives:null, sixes:null, threeOfKind:null, fourOfKind:null, fullHouse:null, smallStraight:null, largeStraight:null, yahtzee:null, chance:null, bonus:0 });
    const upTot = s => ['ones','twos','threes','fours','fives','sixes'].reduce((a,c) => a+(s[c]||0), 0);
    const upBonus = s => upTot(s) >= 63 ? 35 : 0;
    const loTot = s => ['threeOfKind','fourOfKind','fullHouse','smallStraight','largeStraight','yahtzee','chance'].reduce((a,c) => a+(s[c]||0), 0) + (s.bonus||0);
    const grand = s => upTot(s) + upBonus(s) + loTot(s);
    const color = id => { const i = S.known.findIndex(p => p.id === id); return COLORS[i % COLORS.length]; };
    
    const isGameComplete = () => {
      return S.game.every(p => {
        const s = p.scores;
        return s.ones !== null && s.twos !== null && s.threes !== null &&
               s.fours !== null && s.fives !== null && s.sixes !== null &&
               s.threeOfKind !== null && s.fourOfKind !== null && s.fullHouse !== null &&
               s.smallStraight !== null && s.largeStraight !== null && s.yahtzee !== null && s.chance !== null;
      });
    };

    // Dice rolling functions
    const rollDie = () => Math.floor(Math.random() * 6) + 1;

    const rollDice = () => {
      if (!S.turnStarted || S.rolling || S.rollCount >= 3) return;

      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate([50, 30, 50, 30, 50]);
      }

      S.rolling = true;
      R();

      // Animate for 400ms
      let animCount = 0;
      const animInterval = setInterval(() => {
        S.dice = S.dice.map((d, i) => S.held[i] ? d : rollDie());
        R();
        animCount++;
        if (animCount >= 8) {
          clearInterval(animInterval);
          S.rolling = false;
          S.rollCount++;
          R();

          // Check for Yahtzee and notify
          if (calcScore(S.dice, 'yahtzee') === 50) {
            showToast('üéâ YAHTZEE!');
            if (navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
          }
        }
      }, 50);
    };

    const toggleHold = (index) => {
      if (S.rollCount === 0 || S.rolling) return; // Can't hold before first roll
      S.held[index] = !S.held[index];

      // Brief haptic feedback (like keyboard typing)
      if (navigator.vibrate) {
        navigator.vibrate(10);
      }

      R();
    };

    const resetDiceForTurn = () => {
      S.dice = [1, 1, 1, 1, 1];
      S.held = [false, false, false, false, false];
      S.rollCount = 0;
      S.rolling = false;
      S.turnStarted = false;
    };

    const startTurn = () => {
      S.turnStarted = true;

      // Haptic feedback when starting turn (similar to roll)
      if (navigator.vibrate) {
        navigator.vibrate([50, 30, 50]);
      }

      R();
    };

    // Score calculation engine for play mode
    const calcScore = (dice, category) => {
      const counts = [0, 0, 0, 0, 0, 0, 0]; // index 0 unused, 1-6 for dice values
      dice.forEach(d => counts[d]++);
      const sum = dice.reduce((a, b) => a + b, 0);
      const sortedCounts = [...counts.slice(1)].sort((a, b) => b - a);
      const uniqueValues = new Set(dice);
      const sortedDice = [...dice].sort((a, b) => a - b);

      switch (category) {
        // Upper section - count specific number
        case 'ones': return counts[1] * 1;
        case 'twos': return counts[2] * 2;
        case 'threes': return counts[3] * 3;
        case 'fours': return counts[4] * 4;
        case 'fives': return counts[5] * 5;
        case 'sixes': return counts[6] * 6;

        // Three of a kind - sum of all dice if 3+ match
        case 'threeOfKind':
          return sortedCounts[0] >= 3 ? sum : 0;

        // Four of a kind - sum of all dice if 4+ match
        case 'fourOfKind':
          return sortedCounts[0] >= 4 ? sum : 0;

        // Full House - 3 of one, 2 of another = 25 points
        case 'fullHouse':
          return (sortedCounts[0] === 3 && sortedCounts[1] === 2) ? 25 : 0;

        // Small Straight - 4 consecutive = 30 points
        case 'smallStraight': {
          const patterns = [[1,2,3,4], [2,3,4,5], [3,4,5,6]];
          const hasSmall = patterns.some(p => p.every(n => uniqueValues.has(n)));
          return hasSmall ? 30 : 0;
        }

        // Large Straight - 5 consecutive = 40 points
        case 'largeStraight': {
          const isLarge = (sortedDice.join('') === '12345' || sortedDice.join('') === '23456');
          return isLarge ? 40 : 0;
        }

        // Yahtzee - all 5 same = 50 points
        case 'yahtzee':
          return sortedCounts[0] === 5 ? 50 : 0;

        // Chance - sum of all dice
        case 'chance':
          return sum;

        default:
          return 0;
      }
    };

    // Get all possible scores for current dice
    const getPossibleScores = (dice) => {
      const categories = ['ones', 'twos', 'threes', 'fours', 'fives', 'sixes',
                          'threeOfKind', 'fourOfKind', 'fullHouse',
                          'smallStraight', 'largeStraight', 'yahtzee', 'chance'];
      const scores = {};
      categories.forEach(cat => {
        scores[cat] = calcScore(dice, cat);
      });
      return scores;
    };
    
    const showToast = (msg) => {
      const toast = document.getElementById('toast');
      toast.innerHTML = '<div class="toast">' + msg + '</div>';
      setTimeout(() => { toast.innerHTML = ''; }, 2000);
    };

    function exportData() {
      const data = {
        version: 1,
        exportedAt: new Date().toISOString(),
        players: JSON.parse(localStorage.getItem('yahtzeeP') || '[]'),
        history: JSON.parse(localStorage.getItem('yahtzeeH') || '[]')
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'yahtzee-data-' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Data exported! üì•');
    }

    function importData(jsonString) {
      try {
        const data = JSON.parse(jsonString);

        // Validate
        if (!data.players || !Array.isArray(data.players) ||
            !data.history || !Array.isArray(data.history)) {
          throw new Error('Invalid file format');
        }

        // Load existing
        let players = JSON.parse(localStorage.getItem('yahtzeeP') || '[]');
        let history = JSON.parse(localStorage.getItem('yahtzeeH') || '[]');

        // Merge players (avoid duplicates by id)
        const existingPlayerIds = new Set(players.map(p => p.id));
        let newPlayersCount = 0;
        for (const player of data.players) {
          if (!existingPlayerIds.has(player.id)) {
            players.push(player);
            newPlayersCount++;
          }
        }

        // Merge history (avoid duplicates by id)
        const existingHistoryIds = new Set(history.map(h => h.id));
        let newHistoryCount = 0;
        for (const entry of data.history) {
          if (!existingHistoryIds.has(entry.id)) {
            history.push(entry);
            newHistoryCount++;
          }
        }

        // Sort history by date (newest first)
        history.sort((a, b) => new Date(b.date) - new Date(a.date));

        // Save
        localStorage.setItem('yahtzeeP', JSON.stringify(players));
        localStorage.setItem('yahtzeeH', JSON.stringify(history));

        // Update state
        S.known = players;
        S.history = history;

        showToast('Imported: ' + newPlayersCount + ' players, ' + newHistoryCount + ' games üì§');
        R();
      } catch (error) {
        alert('Import failed: ' + error.message);
      }
    }

    function triggerImport() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json,.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            importData(event.target.result);
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    function R() {
      const app = document.getElementById('app');
      if (S.view === 'setup') app.innerHTML = setup();
      else if (S.view === 'history') app.innerHTML = hist();
      else app.innerHTML = gameView();
    }

    function navigateTo(view) {
      S.view = view;
      history.pushState({ view: view }, '', '#' + view);
      R();
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', (event) => {
      const previousView = S.view;
      if (event.state && event.state.view) {
        S.view = event.state.view;
      } else {
        // Default to setup if no state
        S.view = 'setup';
      }

      // If going from game back to setup, clear game state to prevent cached scores
      if (previousView === 'game' && S.view === 'setup') {
        S.game = [];
        S.cur = 0;
      }

      R();
    });

    function setup() {
      const pl = S.known.length === 0
        ? '<div class="text-center py-5 text-purple-200"><p class="mb-2">No players yet!</p><button class="btn btn-small glass text-white" onclick="S.mgr=true;R()">+ Add Players</button></div>'
        : S.known.map((p,i) => {
            const sel = S.game.some(g => g.id === p.id);
            const gi = S.game.findIndex(g => g.id === p.id);
            return '<div class="flex items-center gap-2 rounded-xl p-3 '+(sel?'glass-dark':'glass')+'" style="'+(sel?'box-shadow:0 0 0 2px white;':'')+'" onclick="tog('+p.id+')">'+
              '<div class="checkbox">'+(sel?'<div class="checkbox-inner"></div>':'')+'</div>'+
              '<div class="color-dot" style="background:'+COLORS[i%COLORS.length]+'"></div>'+
              '<span class="flex-1 font-medium text-white">'+p.name+'</span>'+
              (sel?'<button class="order-btn" onclick="event.stopPropagation();mv('+gi+',-1)">‚ñ≤</button><button class="order-btn" onclick="event.stopPropagation();mv('+gi+',1)">‚ñº</button>':'')+
              '<button class="btn btn-small glass text-white text-xs" onclick="event.stopPropagation();S.stats=S.known.find(x=>x.id==='+p.id+');R()">üìä</button>'+
            '</div>';
          }).join('');

      const ord = S.game.length > 0 ? '<div class="glass rounded-xl p-3 mt-4"><p class="text-sm text-purple-200 mb-1">Play order:</p><p class="font-medium text-white">'+S.game.map(p=>p.name).join(' ‚Üí ')+'</p></div>' : '';

      const resumeBtn = S.savedGame ?
        '<button class="btn btn-resume mb-4" onclick="resumeGame()">‚ñ∂Ô∏è RESUME GAME</button>'+
        '<button class="btn btn-secondary mb-4" onclick="discardSaved()">üóëÔ∏è Discard Saved Game</button>' : '';

      const modeToggle = '<div class="mode-toggle">'+
        '<button class="mode-btn '+(S.mode==='score'?'active':'')+'" onclick="S.mode=\'score\';R()">üìù Score Only</button>'+
        '<button class="mode-btn '+(S.mode==='play'?'active':'')+'" onclick="S.mode=\'play\';R()">üé≤ Play Mode</button>'+
      '</div>';

      const modeDesc = S.mode === 'play'
        ? '<div class="glass rounded-xl p-3 mb-4"><p class="text-white text-sm font-medium">üé≤ Play Mode</p><p class="text-purple-200 text-xs mt-1">Roll dice on your phone! Shake to roll or tap the button. Scores are calculated automatically.</p></div>'
        : '<div class="glass rounded-xl p-3 mb-4"><p class="text-white text-sm font-medium">üìù Score Mode</p><p class="text-purple-200 text-xs mt-1">Use your own dice. Manually enter scores as you play.</p></div>';

      return '<div class="container" style="min-height:100vh">'+
        '<div class="text-center mb-6"><div class="text-5xl mb-2">üé≤</div><h1 class="text-4xl font-black text-white">YAHTZEE</h1><p class="text-purple-200 text-sm">Score Keeper</p></div>'+
        modeToggle+modeDesc+
        (S.savedGame ? '<div class="glass rounded-2xl p-4 mb-4"><p class="text-white font-bold mb-2">üìå Saved Game '+(S.savedGame.mode === 'play' ? 'üé≤' : 'üìù')+'</p><p class="text-purple-200 text-sm">'+S.savedGame.game.map(p=>p.name).join(', ')+'</p><p class="text-purple-200 text-xs mt-1">Saved '+new Date(S.savedGame.savedAt).toLocaleString()+'</p></div>' : '')+
        resumeBtn+
        '<div class="glass rounded-2xl p-5 mb-4">'+
          '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-white">Select Players</h2><button class="btn btn-small glass text-white" onclick="S.mgr=true;R()">‚öôÔ∏è Manage</button></div>'+
          '<div class="space-y-2">'+pl+'</div>'+ord+
        '</div>'+
        '<button class="btn btn-primary" onclick="start()" '+(S.game.length===0?'disabled':'')+'>'+(S.game.length===0?'Select Players':(S.mode==='play'?'üé≤ START GAME':'üìù START SCORING')+' ('+S.game.length+')')+'</button>'+
        '<button class="btn btn-secondary mt-4" onclick="navigateTo(\'history\')">üìú Game History</button>'+
        '<div class="grid grid-cols-2 gap-2 mt-4">'+
          '<button class="btn btn-secondary" onclick="exportData()">üì• Export</button>'+
          '<button class="btn btn-secondary" onclick="triggerImport()">üì§ Import</button>'+
        '</div>'+
      '</div>'+(S.mgr?mgr():'')+(S.stats?statsModal():'');
    }

    function mgr() {
      const pl = S.known.map((p,i) => 
        '<div class="flex items-center gap-2 bg-gray-50 rounded-xl p-3">'+
          '<div class="color-dot" style="background:'+COLORS[i%COLORS.length]+'"></div>'+
          '<input type="text" class="input flex-1" value="'+p.name+'" onchange="ren('+p.id+',this.value)">'+
          '<button class="delete-btn" onclick="del('+p.id+')">Delete</button>'+
        '</div>'
      ).join('');
      return '<div class="modal-overlay" onclick="S.mgr=false;save();R()"><div class="modal" onclick="event.stopPropagation()">'+
        '<h2 class="text-xl font-black text-gray-800 mb-4">üë• Manage Players</h2>'+
        '<div class="space-y-2 mb-4">'+pl+'</div>'+
        '<div class="flex gap-2 mb-4"><input type="text" id="np" class="input flex-1" placeholder="New player..." onkeypress="if(event.key===\'Enter\')addP()"><button class="btn btn-blue btn-small text-white" onclick="addP()">Add</button></div>'+
        '<button class="btn btn-green font-bold py-3 px-4 rounded-xl w-full" onclick="S.mgr=false;save();R()">Done</button>'+
      '</div></div>';
    }

    function statsModal() {
      const p = S.stats;
      const games = S.history.filter(g => g.players.some(x => x.pid === p.id));
      const res = games.map(g => g.players.find(x => x.pid === p.id)).filter(Boolean);
      const wins = games.filter(g => { const s = [...g.players].sort((a,b) => b.total - a.total); return s[0]?.pid === p.id; }).length;
      const hi = res.length ? Math.max(...res.map(r => r.total)) : 0;
      const avg = res.length ? Math.round(res.reduce((a,r) => a + r.total, 0) / res.length) : 0;
      const ytz = res.reduce((a,r) => a + (r.scores.yahtzee === 50 ? 1 : 0) + (r.scores.bonus / 100), 0);

      const st = res.length === 0 
        ? '<p class="text-center text-gray-400 py-5">No games yet</p>'
        : '<div class="grid grid-cols-2 gap-3 mb-4">'+
            '<div class="bg-blue-50 rounded-xl p-4 text-center"><div class="text-3xl font-black text-blue-600">'+res.length+'</div><div class="text-xs text-gray-500">Games</div></div>'+
            '<div class="bg-yellow-50 rounded-xl p-4 text-center"><div class="text-3xl font-black text-yellow-600">'+wins+'</div><div class="text-xs text-gray-500">Wins ('+(res.length?Math.round(wins/res.length*100):0)+'%)</div></div>'+
            '<div class="bg-green-50 rounded-xl p-4 text-center"><div class="text-3xl font-black text-green-600">'+hi+'</div><div class="text-xs text-gray-500">High Score</div></div>'+
            '<div class="bg-purple-50 rounded-xl p-4 text-center"><div class="text-3xl font-black text-purple-600">'+avg+'</div><div class="text-xs text-gray-500">Average</div></div>'+
          '</div>'+
          '<div class="bg-red-50 rounded-xl p-4 text-center mb-4"><div class="text-3xl font-black text-red-500">üé≤ '+ytz+'</div><div class="text-xs text-gray-500">Yahtzees</div></div>';

      return '<div class="modal-overlay" onclick="S.stats=null;R()"><div class="modal" onclick="event.stopPropagation()">'+
        '<h2 class="text-2xl font-black text-gray-800 mb-1">'+p.name+'</h2><p class="text-gray-500 text-sm mb-4">Statistics</p>'+st+
        '<button class="btn btn-gray font-medium py-3 px-4 rounded-xl w-full" onclick="S.stats=null;R()">Close</button>'+
      '</div></div>';
    }

    function hist() {
      const g = S.history.length === 0 
        ? '<div class="text-center py-5 text-purple-200"><p class="text-5xl mb-4">üìú</p><p>No games yet</p></div>'
        : S.history.map(h => {
            const sorted = [...h.players].sort((a,b) => b.total - a.total);
            const pls = sorted.map((p,i) => 
              '<div class="flex justify-between items-center '+(i===0?'text-yellow-400 font-bold':'text-white')+'">'+
                '<div class="flex items-center gap-2"><div class="color-dot-sm" style="background:'+color(p.pid)+'"></div><span>'+(i===0?'üèÜ ':'')+p.name+'</span></div>'+
                '<span class="text-lg">'+p.total+'</span>'+
              '</div>'
            ).join('');
            return '<div class="glass rounded-2xl p-4">'+
              '<div class="flex justify-between items-start mb-3">'+
                '<div><p class="font-bold text-white">'+new Date(h.date).toLocaleDateString()+'</p><p class="text-sm text-purple-200">'+new Date(h.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+(h.dur?' ‚Ä¢ '+h.dur+'m':'')+'</p></div>'+
                '<button class="delete-btn" style="color:#f87171" onclick="delH('+h.id+')">üóëÔ∏è</button>'+
              '</div>'+
              '<div class="space-y-2">'+pls+'</div>'+
            '</div>';
          }).join('');

      return '<div class="container" style="min-height:100vh">'+
        '<div class="flex items-center justify-between mb-6"><button class="btn-text text-purple-200 text-lg font-medium" onclick="navigateTo(\'setup\')">‚Üê Back</button><h1 class="text-2xl font-black text-white">üìú History</h1><div style="width:4rem"></div></div>'+
        '<div class="space-y-3">'+g+'</div>'+
      '</div>';
    }

    // Dice face display using dots
    const dieFace = (value) => {
      const dots = {
        1: '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:10px;height:10px;background:#1f2937;border-radius:50%"></div>',
        2: '<div style="position:absolute;top:20%;left:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;bottom:20%;right:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div>',
        3: '<div style="position:absolute;top:20%;left:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;bottom:20%;right:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div>',
        4: '<div style="position:absolute;top:20%;left:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;top:20%;right:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;bottom:20%;left:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;bottom:20%;right:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div>',
        5: '<div style="position:absolute;top:20%;left:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;top:20%;right:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;bottom:20%;left:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;bottom:20%;right:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div>',
        6: '<div style="position:absolute;top:20%;left:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;top:20%;right:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;top:50%;left:20%;transform:translateY(-50%);width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;top:50%;right:20%;transform:translateY(-50%);width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;bottom:20%;left:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div><div style="position:absolute;bottom:20%;right:20%;width:8px;height:8px;background:#1f2937;border-radius:50%"></div>'
      };
      return dots[value] || '';
    };

    function gameView() {
      const cp = S.game[S.cur];
      const sc = cp.scores;
      const isPlayMode = S.mode === 'play';
      const possibleScores = isPlayMode && S.rollCount > 0 ? getPossibleScores(S.dice) : {};
      const canSelectScore = isPlayMode && S.rollCount > 0 && !S.rolling;

      const tabs = S.game.map((p,i) =>
        '<button class="player-tab flex-shrink-0 '+(i===S.cur?'player-tab-active':'player-tab-inactive')+'" style="'+(i===S.cur?'background:'+color(p.id):'')+'" onclick="switchPlayer('+i+')">'+p.name+': '+grand(p.scores)+'</button>'
      ).join('');

      // Dice area for play mode
      const diceArea = isPlayMode ? '<div class="dice-area">'+
        (S.turnStarted ?
          // Turn started - show dice and roll button
          '<div class="roll-info">'+
            '<span class="roll-count">'+(S.rollCount === 0 ? 'Roll to start!' : 'Roll '+S.rollCount+' of 3')+'</span>'+
            '<span class="shake-hint">'+(S.shakeEnabled ? 'üì≥ Shake enabled' : 'Tap button to roll')+'</span>'+
          '</div>'+
          '<div class="dice-container" style="padding-bottom:1.5rem">'+
            S.dice.map((d, i) =>
              '<div class="die '+(S.held[i]?'held':'')+(S.rolling && !S.held[i]?' rolling':'')+'" onclick="toggleHold('+i+')">'+dieFace(d)+'</div>'
            ).join('')+
          '</div>'+
          '<button class="roll-btn" onclick="rollDice()" '+(S.rollCount >= 3 || S.rolling ? 'disabled' : '')+'>'+
            (S.rollCount === 0 ? 'üé≤ Roll Dice!' : S.rollCount >= 3 ? 'Select a score below' : 'üé≤ Roll Again ('+S.rollCount+'/3)')+
          '</button>'+
          (S.rollCount > 0 && !S.rolling ? '<p class="text-center text-xs mt-2" style="color:rgba(255,255,255,0.6)">Tap dice to hold/release</p>' : '')
        :
          // Turn not started - show start button
          '<div class="text-center py-4">'+
            '<p class="text-white text-lg font-bold mb-2">Ready to roll?</p>'+
            '<p class="text-white text-xs mb-4" style="opacity:0.7">Tap the button when you\'re ready</p>'+
            '<button class="roll-btn" onclick="startTurn()" style="background:linear-gradient(to right,#8b5cf6,#7c3aed)">'+
              'üëÜ Start My Turn'+
            '</button>'+
          '</div>'
        )+
      '</div>' : '';

      // Score buttons for play mode vs score mode
      const up = UPPER.map(c => {
        const v = sc[c.id];
        const possible = possibleScores[c.id];
        const canSelect = canSelectScore && v === null;

        if (isPlayMode) {
          // Play mode - show calculated scores
          if (v !== null) {
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-800">'+c.name+'</span>'+
              '<div class="flex items-center gap-2">'+
                '<button class="clear-btn" onclick="clr(\''+c.id+'\')">‚úï</button>'+
                '<span class="score-btn score-filled-blue">'+v+'</span>'+
              '</div>'+
            '</div><div class="divider"></div>';
          } else if (canSelect) {
            const btnClass = possible > 0 ? 'score-available' : 'score-zero-only';
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-800">'+c.name+'</span>'+
              '<button class="score-btn-play '+btnClass+'" onclick="selectPlayScore(\''+c.id+'\','+possible+')">'+possible+'</button>'+
            '</div><div class="divider"></div>';
          } else {
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-400">'+c.name+'</span>'+
              '<span class="score-btn score-empty">-</span>'+
            '</div><div class="divider"></div>';
          }
        } else {
          // Score mode - original behavior
          return '<div class="flex items-center justify-between px-4 py-3">'+
            '<div class="flex-1"><span class="font-medium text-gray-800">'+c.name+'</span><span class="text-xs text-gray-400 ml-2">('+[0,1,2,3,4,5].map(n=>n*c.value).join(',')+')</span></div>'+
            '<div class="flex items-center gap-2">'+
              (v!==null?'<button class="clear-btn" onclick="clr(\''+c.id+'\')">‚úï</button>':'')+
              '<button class="score-btn '+(v!==null?'score-filled-blue':'score-empty')+'" onclick="openUp(\''+c.id+'\','+c.value+',\''+c.name+'\')">'+(v!==null?v:'Tap')+'</button>'+
            '</div>'+
          '</div><div class="divider"></div>';
        }
      }).join('');

      const lo = LOWER.map(c => {
        const v = sc[c.id];
        const possible = possibleScores[c.id];
        const canSelect = canSelectScore && v === null;

        if (isPlayMode) {
          // Play mode - show calculated scores
          if (v !== null) {
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-800">'+c.name+'</span>'+
              '<div class="flex items-center gap-2">'+
                '<button class="clear-btn" onclick="clr(\''+c.id+'\')">‚úï</button>'+
                '<span class="score-btn score-filled-purple">'+v+'</span>'+
              '</div>'+
            '</div><div class="divider"></div>';
          } else if (canSelect) {
            const btnClass = possible > 0 ? 'score-available' : 'score-zero-only';
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-800">'+c.name+'</span>'+
              '<button class="score-btn-play '+btnClass+'" onclick="selectPlayScore(\''+c.id+'\','+possible+')">'+possible+'</button>'+
            '</div><div class="divider"></div>';
          } else {
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-400">'+c.name+'</span>'+
              '<span class="score-btn score-empty">-</span>'+
            '</div><div class="divider"></div>';
          }
        } else {
          // Score mode - original behavior
          return '<div class="flex items-center justify-between px-4 py-3">'+
            '<div class="flex-1"><span class="font-medium text-gray-800">'+c.name+'</span><span class="text-xs text-gray-400 ml-2">'+(c.type==='fixed'?'(0/'+c.fixed+')':'(0-'+c.max+')')+'</span></div>'+
            '<div class="flex items-center gap-2">'+
              (v!==null?'<button class="clear-btn" onclick="clr(\''+c.id+'\')">‚úï</button>':'')+
              '<button class="score-btn '+(v!==null?'score-filled-purple':'score-empty')+'" onclick="openLo(\''+c.id+'\',\''+c.type+'\','+(c.fixed||c.max)+',\''+c.name+'\')">'+(v!==null?v:'Tap')+'</button>'+
            '</div>'+
          '</div><div class="divider"></div>';
        }
      }).join('');

      const stand = [...S.game].map(p => ({...p, t: grand(p.scores)})).sort((a,b) => b.t - a.t).map((p,r) =>
        '<div class="flex items-center gap-3">'+
          '<span class="text-xl" style="width:2rem;text-align:center">'+(r===0?'ü•á':r===1?'ü•à':r===2?'ü•â':r+1)+'</span>'+
          '<div class="flex-1 rounded-xl bg-gray-100" style="height:2.5rem"><div class="standing-bar" style="background:'+color(p.id)+';width:'+Math.max(30,p.t/4)+'%">'+p.name+'</div></div>'+
          '<span class="font-black text-lg" style="width:3rem;text-align:right">'+p.t+'</span>'+
        '</div>'
      ).join('');

      const gameComplete = isGameComplete();

      // Yahtzee bonus section - handle both modes
      const yahtzeeBonus = isPlayMode
        ? '<div class="flex items-center justify-between px-4 py-3 bg-yellow-50">'+
            '<div><span class="font-bold text-yellow-800">Yahtzee Bonus</span><span class="text-yellow-600 text-xs ml-2">+100 each</span></div>'+
            '<span class="font-black text-xl text-yellow-600">+'+sc.bonus+'</span>'+
          '</div>'
        : '<div class="flex items-center justify-between px-4 py-3 bg-yellow-50">'+
            '<div><span class="font-bold text-yellow-800">Yahtzee Bonus</span><span class="text-yellow-600 text-xs ml-2">+100 each</span></div>'+
            '<div class="flex items-center gap-2"><span class="font-black text-xl text-yellow-600">+'+sc.bonus+'</span><button class="btn btn-small '+(sc.yahtzee===50?'btn-yellow':'btn-gray-dark')+' font-bold" onclick="addBonus()" '+(sc.yahtzee!==50?'disabled':'')+'>+100</button></div>'+
          '</div>';

      return '<div style="min-height:100vh;background:#f9fafb;padding-bottom:6rem">'+
        '<div class="header-gradient text-white p-3 sticky"><div class="flex justify-between items-center" style="max-width:28rem;margin:0 auto">'+
          '<button class="btn-text text-white text-lg font-medium" onclick="pauseG()">‚Üê Back</button>'+
          '<h1 class="font-black text-lg">'+(isPlayMode?'üé≤ YAHTZEE':'üìù SCORING')+'</h1>'+
          '<button class="btn btn-small '+(gameComplete?'btn-green':'btn-orange')+'" onclick="'+(gameComplete?'finishG()':'saveG()')+'">'+(gameComplete?'Finish ‚úì':'Save')+'</button>'+
        '</div></div>'+
        '<div class="bg-white shadow-md sticky-tabs"><div class="flex overflow-x-auto py-2 px-2 gap-2" style="max-width:28rem;margin:0 auto">'+tabs+'</div></div>'+
        '<div class="p-3" style="max-width:28rem;margin:0 auto">'+
          '<div class="card p-4 mb-4" style="border-left:4px solid '+color(cp.id)+'">'+
            '<div class="current-turn-indicator"><div class="pulse-dot"></div><span class="text-gray-500 text-sm font-medium">Current Turn</span></div>'+
            '<h2 class="font-black text-2xl" style="color:'+color(cp.id)+'">'+cp.name+'</h2>'+
          '</div>'+
          diceArea+
          '<div class="card mb-4">'+
            '<div class="upper-gradient text-white px-4 py-3 flex justify-between items-center"><span class="font-bold">Upper Section</span><span class="text-sm px-2 py-1 rounded-full '+(upTot(sc)>=63?'bg-green-400':'glass')+'">'+upTot(sc)+'/63</span></div>'+
            up+
            '<div class="flex items-center justify-between px-4 py-3 bg-blue-50"><span class="font-bold text-blue-800">Upper Bonus</span><span class="font-black text-xl '+(upBonus(sc)?'text-green-600':'text-gray-400')+'">'+(upBonus(sc)?'+35 ‚úì':'0')+'</span></div>'+
          '</div>'+
          '<div class="card mb-4">'+
            '<div class="lower-gradient text-white px-4 py-3 font-bold">Lower Section</div>'+
            lo+
            yahtzeeBonus+
          '</div>'+
          '<div class="total-gradient text-white rounded-2xl shadow-lg p-5 mb-4"><div class="flex justify-between items-center">'+
            '<div><p style="opacity:0.7" class="text-sm">Grand Total</p><p class="text-4xl font-black">'+grand(sc)+'</p></div>'+
            '<div class="text-sm" style="text-align:right;opacity:0.7"><p>Upper: '+upTot(sc)+' + '+upBonus(sc)+'</p><p>Lower: '+loTot(sc)+'</p></div>'+
          '</div></div>'+
          '<div class="card p-4"><h3 class="font-bold mb-3 text-gray-800">üèÜ Standings</h3><div class="space-y-2">'+stand+'</div></div>'+
        '</div>'+
      '</div>'+(S.picker?picker():'');
    }

    function picker() {
      const c = S.picker;
      if (c.t === 'upper') {
        const btns = [0,1,2,3,4,5].map(n => 
          '<button class="picker-btn" onclick="sel('+n*c.v+')"><div class="text-2xl font-black text-blue-600">'+n*c.v+'</div><div class="text-xs text-gray-500">'+n+' √ó '+c.v+'</div></button>'
        ).join('');
        return '<div class="modal-overlay" onclick="S.picker=null;R()"><div class="modal" onclick="event.stopPropagation()">'+
          '<div class="text-center mb-4"><h3 class="text-xl font-black text-gray-800">'+c.name+'</h3><p class="text-blue-600 text-sm mt-1">How many '+c.v+'s did you roll?</p></div>'+
          '<div class="grid grid-cols-3 gap-2 mb-4">'+btns+'</div>'+
          '<button class="btn btn-gray font-medium py-3 px-4 rounded-xl w-full" onclick="S.picker=null;R()">Cancel</button>'+
        '</div></div>';
      } else if (c.t === 'fixed') {
        return '<div class="modal-overlay" onclick="S.picker=null;R()"><div class="modal" onclick="event.stopPropagation()">'+
          '<div class="text-center mb-4"><h3 class="text-xl font-black text-gray-800">'+c.name+'</h3></div>'+
          '<div class="grid grid-cols-2 gap-3 mb-4">'+
            '<button class="picker-btn-green p-4" onclick="sel('+c.v+')"><div class="text-3xl font-black text-green-600">‚úì '+c.v+'</div><div class="text-sm text-green-700 font-medium">Got it!</div></button>'+
            '<button class="picker-btn-red p-4" onclick="sel(0)"><div class="text-3xl font-black text-red-400">‚úó 0</div><div class="text-sm text-red-500 font-medium">Missed</div></button>'+
          '</div>'+
          '<button class="btn btn-gray font-medium py-3 px-4 rounded-xl w-full" onclick="S.picker=null;R()">Cancel</button>'+
        '</div></div>';
      } else {
        const quick = [5,10,15,20,25,30].map(n => '<button class="picker-btn-purple text-purple-700 font-bold text-sm" onclick="sel('+n+')">'+n+'</button>').join('');
        return '<div class="modal-overlay" onclick="S.picker=null;R()"><div class="modal" onclick="event.stopPropagation()">'+
          '<div class="text-center mb-4"><h3 class="text-xl font-black text-gray-800">'+c.name+'</h3><p class="text-purple-600 text-xs mt-1">Sum of all dice (5-30)</p></div>'+
          '<button class="picker-btn-red w-full mb-3 p-3" onclick="sel(0)"><span class="font-black text-red-500">‚úó Score 0</span></button>'+
          '<p class="text-xs text-gray-400 mb-2 text-center">Quick select:</p>'+
          '<div class="grid grid-cols-6 gap-1 mb-3">'+quick+'</div>'+
          '<div class="flex gap-2 mb-4"><input type="number" id="cust" min="5" max="30" class="input flex-1 text-center text-xl font-bold" placeholder="Custom..."><button class="btn btn-purple font-bold py-3 px-4 rounded-xl" onclick="subCust()">‚úì</button></div>'+
          '<button class="btn btn-gray font-medium py-3 px-4 rounded-xl w-full" onclick="S.picker=null;R()">Cancel</button>'+
        '</div></div>';
      }
    }

    function tog(id) {
      const p = S.known.find(x => x.id === id);
      const ex = S.game.find(x => x.id === id);
      if (ex) S.game = S.game.filter(x => x.id !== id);
      else if (S.game.length < 8) S.game.push({...p, scores: empty()});
      R();
    }

    function mv(i, d) {
      const ni = i + d;
      if (ni < 0 || ni >= S.game.length) return;
      const t = S.game[i];
      S.game[i] = S.game[ni];
      S.game[ni] = t;
      R();
    }

    function addP() {
      const inp = document.getElementById('np');
      if (inp && inp.value.trim()) {
        S.known.push({id: Date.now(), name: inp.value.trim()});
        inp.value = '';
        save();
        R();
      }
    }

    function ren(id, name) {
      const p = S.known.find(x => x.id === id);
      if (p && name.trim()) p.name = name.trim();
      save();
    }

    function del(id) {
      if (confirm('Delete player?')) {
        S.known = S.known.filter(x => x.id !== id);
        S.game = S.game.filter(x => x.id !== id);
        save();
        R();
      }
    }

    function start() {
      if (S.game.length === 0) return;
      S.start = Date.now();
      S.cur = 0;
      clearSavedGame();

      // Reset dice state for play mode
      if (S.mode === 'play') {
        resetDiceForTurn();
        setupShakeDetection();
      }

      navigateTo('game');
    }

    // Select score in play mode
    function selectPlayScore(categoryId, score) {
      const cp = S.game[S.cur];

      // Handle Yahtzee bonus: if rolling another Yahtzee and first was scored (not 0)
      if (calcScore(S.dice, 'yahtzee') === 50 && cp.scores.yahtzee === 50) {
        cp.scores.bonus += 100;
        showToast('YAHTZEE BONUS! +100');
      }

      // Set the score
      cp.scores[categoryId] = score;

      // Move to next player
      const nextPlayer = (S.cur + 1) % S.game.length;
      const nextPlayerName = S.game[nextPlayer].name;
      S.cur = nextPlayer;

      // Reset dice for next turn
      resetDiceForTurn();

      // Save game state AFTER moving to next player and resetting dice
      saveCurrentGame();

      R();
      // Scroll to top to show dice area and current player
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showToast(nextPlayerName + "'s turn");
    }

    // Shake detection setup
    function setupShakeDetection() {
      const SHAKE_THRESHOLD = 20;
      const SHAKE_COOLDOWN = 2000; // 2 seconds between shakes to prevent accidental double-rolls

      // Check if DeviceMotionEvent is available
      if (!('DeviceMotionEvent' in window)) {
        S.shakeEnabled = false;
        return;
      }

      // iOS 13+ requires permission
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        // Request permission on first interaction
        const requestMotionPermission = async () => {
          try {
            const permission = await DeviceMotionEvent.requestPermission();
            if (permission === 'granted') {
              S.shakeEnabled = true;
              addShakeListener();
              R();
            }
          } catch (e) {
            console.log('Motion permission denied:', e);
          }
          // Remove this listener after first attempt
          document.removeEventListener('click', requestMotionPermission);
        };
        document.addEventListener('click', requestMotionPermission, { once: true });
        showToast('Tap anywhere to enable shake');
      } else {
        // Non-iOS or older iOS - just add listener
        S.shakeEnabled = true;
        addShakeListener();
      }

      function addShakeListener() {
        window.addEventListener('devicemotion', (e) => {
          if (S.view !== 'game' || S.mode !== 'play') return;
          if (!S.turnStarted || S.rolling || S.rollCount >= 3) return;

          const acc = e.accelerationIncludingGravity;
          if (!acc) return;

          const total = Math.sqrt(
            (acc.x || 0) ** 2 +
            (acc.y || 0) ** 2 +
            (acc.z || 0) ** 2
          );

          const now = Date.now();
          // Subtract gravity (~9.8) and check threshold
          if (total > SHAKE_THRESHOLD && now - S.lastShake > SHAKE_COOLDOWN) {
            S.lastShake = now;
            rollDice();
          }
        });
      }
    }
    
    function resumeGame() {
      if (S.savedGame) {
        S.game = S.savedGame.game;
        S.cur = S.savedGame.cur;
        S.start = S.savedGame.start;
        // Restore play mode state
        if (S.savedGame.mode) {
          S.mode = S.savedGame.mode;
          S.dice = S.savedGame.dice || [1, 1, 1, 1, 1];
          S.held = S.savedGame.held || [false, false, false, false, false];
          S.rollCount = S.savedGame.rollCount || 0;
          S.turnStarted = S.savedGame.turnStarted || false;
          if (S.mode === 'play') {
            setupShakeDetection();
          }
        }
        showToast('Game resumed!');
        navigateTo('game');
      }
    }
    
    function discardSaved() {
      if (confirm('Discard saved game?')) {
        clearSavedGame();
        // Clear the current game state to prevent cached scores
        S.game = [];
        S.cur = 0;
        R();
      }
    }

    function delH(id) {
      if (confirm('Delete game?')) {
        S.history = S.history.filter(x => x.id !== id);
        save();
        R();
      }
    }

    function next() {
      S.cur = (S.cur + 1) % S.game.length;
      R();
    }

    function switchPlayer(index) {
      if (index === S.cur) return; // Already on this player

      // In play mode, reset dice when switching players
      if (S.mode === 'play') {
        resetDiceForTurn();
      }

      S.cur = index;
      saveCurrentGame();
      R();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function openUp(id, v, name) { S.picker = {id, v, name, t: 'upper'}; R(); }
    function openLo(id, type, v, name) { S.picker = {id, v, name, t: type}; R(); }

    function sel(v) {
      S.game[S.cur].scores[S.picker.id] = v;
      S.picker = null;

      // Auto-advance to next player
      const nextPlayer = (S.cur + 1) % S.game.length;
      const nextPlayerName = S.game[nextPlayer].name;
      S.cur = nextPlayer;

      // Auto-save game state AFTER advancing to next player
      saveCurrentGame();

      R();
      // Scroll to top to show current player and scores
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showToast(nextPlayerName + "'s turn");
    }

    function subCust() {
      const inp = document.getElementById('cust');
      const v = parseInt(inp.value);
      if (v >= 0 && v <= 30) sel(v);
    }

    function clr(id) { 
      S.game[S.cur].scores[id] = null; 
      saveCurrentGame();
      R(); 
    }

    function addBonus() {
      if (S.game[S.cur].scores.yahtzee === 50) {
        S.game[S.cur].scores.bonus += 100;
        saveCurrentGame();
        R();
      }
    }

    function pauseG() {
      saveCurrentGame();
      S.game = [];
      S.cur = 0;
      showToast('Game paused & saved! ‚è∏Ô∏è');
      navigateTo('setup');
    }

    function saveG() {
      saveCurrentGame();
      showToast('Progress saved!');
    }
    
    function finishG() {
      const rec = {
        id: Date.now(),
        date: new Date().toISOString(),
        dur: S.start ? Math.round((Date.now() - S.start) / 60000) : null,
        players: S.game.map(p => ({pid: p.id, name: p.name, scores: {...p.scores}, total: grand(p.scores)}))
      };
      S.history.unshift(rec);
      save();
      clearSavedGame();
      S.game = [];
      S.cur = 0;
      showToast('Game finished! üéâ');
      navigateTo('setup');
    }

    // Initialize history state
    history.replaceState({ view: S.view }, '', '#' + S.view);
    R();

    // Load and display version
    fetch('version.json')
      .then(res => res.json())
      .then(data => {
        const versionEl = document.getElementById('version');
        if (versionEl) {
          versionEl.textContent = `v${data.version} (${data.commit})`;
        }
      })
      .catch(() => {
        // Fallback if version.json doesn't load
        const versionEl = document.getElementById('version');
        if (versionEl) {
          versionEl.textContent = 'v1.0.0';
        }
      });

    // Register service worker for PWA with update detection
    if ('serviceWorker' in navigator) {
      let refreshing = false;

      // Reload page when new service worker takes over
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
          refreshing = true;
          window.location.reload();
        }
      });

      navigator.serviceWorker.register('sw.js').then(reg => {
        // Check for updates periodically
        setInterval(() => {
          reg.update();
        }, 60000); // Check every minute

        // Handle updates
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New service worker available, show update prompt
              showUpdatePrompt();
            }
          });
        });
      }).catch(err => console.log('SW registration failed:', err));
    }

    function showUpdatePrompt() {
      const banner = document.createElement('div');
      banner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:#4f46e5;color:white;padding:1rem;text-align:center;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.3);';
      banner.innerHTML = '<div style="max-width:28rem;margin:0 auto;"><strong>üéâ Update Available!</strong><br><small>A new version is ready. Your data is safe.</small><br><button style="margin-top:0.5rem;background:white;color:#4f46e5;border:none;padding:0.5rem 1.5rem;border-radius:0.5rem;font-weight:bold;cursor:pointer;" onclick="window.location.reload()">Update Now</button> <button style="margin-top:0.5rem;background:transparent;color:white;border:1px solid white;padding:0.5rem 1rem;border-radius:0.5rem;cursor:pointer;" onclick="this.parentElement.parentElement.remove()">Later</button></div>';
      document.body.appendChild(banner);
    }
  </script>
</body>
</html>
