<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0D1A14">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="manifest" href="manifest.json">
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="apple-touch-icon" href="icon-192.png">
  <title>Yahtzee Scorer</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }

    :root {
      /* Surfaces */
      --bg: #0D1A14;
      --surface: #13231C;
      --surface2: #182C24;
      --border: #2A4A3A;

      /* Text & icons */
      --text: #E6F3ED;
      --muted: #A9C5B9;
      --icon: #A9C5B9;
      --onAccent: #0B1611;
      --onLink: #0B1611;

      /* Brand / interaction */
      --accent: #39C6A7;
      --accentDark: #2DA589;
      --link: #7AE7D0;
      --linkHover: #5DD4B8;

      /* Status */
      --success: #34D399;
      --warning: #F4B24A;
      --error: #FB7185;

      /* State colors */
      --surfaceHover: #1F2E27;
      --surfacePressed: #283730;
      --surface2Hover: #24372F;
      --surface2Pressed: #2D3F38;
      --accentSubtle: #1C3E34;

      /* Emphasized borders & focus */
      --borderAccent: #2F7560;
      --borderFocus: #328E76;
      --focusRing: rgba(57, 198, 167, 0.35);
      --focusRingStrong: rgba(57, 198, 167, 0.55);

      /* Overlays */
      --scrim: rgba(0, 0, 0, 0.55);
      --tooltipBg: var(--surface2);
      --tooltipText: var(--text);
      --divider: var(--border);

      /* Skeleton loading */
      --skeletonBase: var(--surface2);
      --skeletonShimmer: var(--surface2Hover);

      /* Spacing scale */
      --s1: 4px;
      --s2: 8px;
      --s3: 12px;
      --s4: 16px;
      --s5: 20px;
      --s6: 24px;
      --s7: 32px;

      /* Radii */
      --rSm: 10px;
      --rMd: 14px;
      --rLg: 18px;
      --rPill: 999px;

      /* Shadows */
      --shadowSm: 0 6px 18px rgba(0,0,0,.28);
      --shadowMd: 0 12px 30px rgba(0,0,0,.32);
      --shadowLg: 0 20px 50px rgba(0,0,0,.38);
      --innerHighlight: inset 0 1px 0 rgba(255,255,255,.04);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, var(--surface2) 50%, var(--surface) 100%);
      color: var(--text);
      min-height: 100vh;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }
    .container { max-width: 28rem; margin: 0 auto; padding: 1rem; }
    .text-center { text-align: center; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mb-6 { margin-bottom: 1.5rem; }
    .mt-4 { margin-top: 1rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-5 { padding: 1.25rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
    .py-5 { padding-top: 1.25rem; padding-bottom: 1.25rem; }
    .gap-2 { gap: 0.5rem; }
    .gap-3 { gap: 0.75rem; }
    .flex { display: flex; }
    .flex-1 { flex: 1; }
    .w-full { width: 100%; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .justify-center { justify-content: center; }
    .grid { display: grid; }
    .grid-cols-2 { grid-template-columns: repeat(2, 1fr); }
    .grid-cols-3 { grid-template-columns: repeat(3, 1fr); }
    .grid-cols-6 { grid-template-columns: repeat(6, 1fr); }
    .space-y-2 > * + * { margin-top: 0.5rem; }
    .space-y-3 > * + * { margin-top: 0.75rem; }
    .overflow-x-auto { overflow-x: auto; }
    .whitespace-nowrap { white-space: nowrap; }
    .flex-shrink-0 { flex-shrink: 0; }
    
    .rounded-lg { border-radius: 0.5rem; }
    .rounded-xl { border-radius: 0.75rem; }
    .rounded-2xl { border-radius: 1rem; }
    .rounded-full { border-radius: 9999px; }
    
    .text-xs { font-size: 0.75rem; }
    .text-sm { font-size: 0.875rem; }
    .text-lg { font-size: 1.125rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .text-3xl { font-size: 1.875rem; }
    .text-4xl { font-size: 2.25rem; }
    .text-5xl { font-size: 3rem; }
    .font-medium { font-weight: 500; }
    .font-bold { font-weight: 700; }
    .font-black { font-weight: 900; }
    
    .text-white { color: var(--text); }
    .text-gray-400 { color: var(--muted); }
    .text-gray-500 { color: var(--muted); }
    .text-gray-600 { color: var(--border); }
    .text-gray-800 { color: var(--text); }
    .text-purple-200 { color: var(--link); }
    .text-purple-600 { color: var(--accent); }
    .text-purple-700 { color: var(--accentDark); }
    .text-blue-600 { color: var(--link); }
    .text-blue-700 { color: var(--linkHover); }
    .text-blue-800 { color: var(--accent); }
    .text-green-600 { color: var(--link); }
    .text-green-700 { color: var(--linkHover); }
    .text-red-400 { color: var(--error); }
    .text-red-500 { color: var(--error); }
    .text-yellow-400 { color: var(--linkHover); }
    .text-yellow-600 { color: var(--accent); }
    .text-yellow-800 { color: var(--accentDark); }

    .bg-gray-100 { background-color: var(--surface2); }

    .glass {
      background: rgba(24, 44, 36, 0.5);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(169, 197, 185, 0.15);
    }
    .glass-dark {
      background: rgba(24, 44, 36, 0.7);
      backdrop-filter: blur(12px);
    }

    .shadow-md { box-shadow: var(--shadowMd); }
    .shadow-lg { box-shadow: var(--shadowLg); }
    
    /* Base button - NO background defined here */
    .btn { 
      border: none; 
      cursor: pointer; 
      transition: all 0.15s; 
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn:active { transform: scale(0.95); }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    
    /* Text-only button (transparent background) */
    .btn-text {
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .btn-text:active { transform: scale(0.95); opacity: 0.7; }
    
    /* Primary action button */
    .btn-primary {
      background: var(--accent);
      color: var(--onAccent);
      font-weight: 900;
      padding: 1.25rem;
      border-radius: var(--rMd);
      font-size: 1.25rem;
      width: 100%;
      box-shadow: var(--shadowSm);
      border: none;
    }
    .btn-primary:hover {
      box-shadow: 0 8px 24px rgba(57, 198, 167, 0.4);
      transform: translateY(-1px);
    }
    .btn-primary:focus {
      box-shadow: 0 0 0 2px var(--focusRing), 0 0 12px var(--focusRing), var(--shadowSm);
    }
    
    /* Resume game button */
    .btn-resume {
      background: var(--link);
      color: var(--onLink);
      font-weight: 900;
      padding: 1.25rem;
      border-radius: var(--rMd);
      font-size: 1.25rem;
      width: 100%;
      box-shadow: var(--shadowSm);
      border: none;
    }
    .btn-resume:hover {
      box-shadow: 0 8px 24px rgba(122, 231, 208, 0.4);
      transform: translateY(-1px);
    }

    /* Secondary button */
    .btn-secondary {
      background: var(--surface2);
      color: var(--text);
      font-weight: 700;
      padding: 1rem;
      border-radius: var(--rMd);
      width: 100%;
      border: 1px solid var(--border);
    }
    .btn-secondary:hover {
      background: var(--surface2Hover);
      border-color: var(--borderAccent);
    }
    .btn-secondary:active {
      background: var(--surface2Pressed);
    }

    /* Small button base */
    .btn-small {
      padding: 0.5rem 0.75rem;
      font-size: 0.875rem;
      border-radius: var(--rSm);
      font-weight: 600;
    }

    /* Colored buttons - used in modals */
    .btn-blue {
      background-color: var(--link);
      color: var(--onLink);
    }
    .btn-green {
      background-color: var(--success);
      color: var(--onLink);
    }
    .btn-purple {
      background-color: var(--accent);
      color: var(--onAccent);
    }
    .btn-orange {
      background-color: var(--warning);
      color: var(--onLink);
    }
    .btn-yellow {
      background-color: var(--warning);
      color: var(--onLink);
    }
    .btn-gray {
      background-color: var(--surface2);
      color: var(--muted);
      border: 1px solid var(--border);
    }
    .btn-gray:hover {
      background-color: var(--surface2Hover);
    }
    .btn-gray-dark {
      background-color: var(--surface);
      color: var(--muted);
      border: 1px solid var(--border);
    }
    .btn-gray-dark:hover {
      background-color: var(--surfaceHover);
    }
    
    .input {
      border: 2px solid var(--border);
      border-radius: var(--rMd);
      padding: 0.75rem 1rem;
      font-size: 1rem;
      width: 100%;
      font-family: inherit;
      background: var(--surface2);
      color: var(--text);
      transition: all 0.2s;
    }
    .input:hover {
      border-color: var(--borderAccent);
    }
    .input:focus {
      outline: none;
      border-color: var(--borderFocus);
      box-shadow: 0 0 0 2px var(--focusRing), 0 0 12px var(--focusRing);
    }

    .card {
      background: var(--surface);
      border-radius: var(--rLg);
      box-shadow: var(--shadowMd), var(--innerHighlight);
      overflow: hidden;
      border: 1px solid var(--border);
    }
    .score-section-card {
      min-height: 28rem;
    }
    
    .header-gradient { background: linear-gradient(to right, var(--accent), var(--accentDark)); }
    .upper-gradient { background: linear-gradient(to right, var(--accent), var(--accentDark)); }
    .lower-gradient { background: linear-gradient(to right, var(--accent), var(--accentDark)); }
    .total-gradient { background: linear-gradient(to right, var(--accent), var(--accentDark)); }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--scrim);
      backdrop-filter: blur(4px); 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      z-index: 50; 
      padding: 1rem; 
    }
    .modal {
      background: var(--surface2);
      border-radius: var(--rLg);
      padding: 1.25rem;
      width: 100%;
      max-width: 24rem;
      max-height: 80vh;
      overflow: auto;
      border: 1px solid var(--border);
      box-shadow: var(--shadowLg);
    }
    
    .color-dot { width: 1rem; height: 1rem; border-radius: 9999px; flex-shrink: 0; }
    .color-dot-sm { width: 0.75rem; height: 0.75rem; border-radius: 9999px; flex-shrink: 0; }
    
    .checkbox {
      width: 1.25rem;
      height: 1.25rem;
      border-radius: 9999px;
      border: 2px solid var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    .checkbox-inner { width: 0.75rem; height: 0.75rem; border-radius: 9999px; background: var(--text); }
    
    .score-btn {
      min-width: 4rem;
      padding: 0.5rem 1rem;
      border-radius: var(--rMd);
      font-weight: 700;
      font-size: 1.125rem;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .score-btn:active { transform: scale(0.95); }
    .score-btn:hover { opacity: 0.9; }
    .score-filled-blue {
      background-color: rgba(122, 231, 208, 0.15);
      color: var(--link);
      border: 1px solid var(--link);
    }
    .score-filled-purple {
      background-color: var(--accentSubtle);
      color: var(--accent);
      border: 1px solid var(--accent);
    }
    .score-empty {
      background-color: var(--surface2);
      color: var(--muted);
      border: 2px dashed var(--border);
    }
    .score-empty:hover {
      background-color: var(--surface2Hover);
      border-color: var(--borderAccent);
    }

    .picker-btn {
      background-color: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--rMd);
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .picker-btn:hover { background-color: var(--surface2Hover); }
    .picker-btn:active { background-color: var(--surface2Pressed); transform: scale(0.95); }
    .picker-btn-green {
      background-color: rgba(122, 231, 208, 0.12);
      border: 2px solid var(--link);
      border-radius: var(--rMd);
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .picker-btn-green:hover { background-color: rgba(122, 231, 208, 0.2); }
    .picker-btn-green:active { background-color: rgba(122, 231, 208, 0.3); transform: scale(0.95); }
    .picker-btn-red {
      background-color: rgba(251, 113, 133, 0.12);
      border: 2px solid var(--error);
      border-radius: var(--rMd);
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .picker-btn-red:hover { background-color: rgba(251, 113, 133, 0.2); }
    .picker-btn-red:active { background-color: rgba(251, 113, 133, 0.3); transform: scale(0.95); }
    .picker-btn-purple {
      background-color: var(--accentSubtle);
      border: 1px solid var(--accent);
      border-radius: var(--rSm);
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .picker-btn-purple:hover { background-color: rgba(57, 198, 167, 0.2); }
    .picker-btn-purple:active { background-color: rgba(57, 198, 167, 0.3); transform: scale(0.95); }

    .player-tab {
      padding: 0.5rem 1rem;
      border-radius: var(--rPill);
      font-size: 0.875rem;
      font-weight: 700;
      white-space: nowrap;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .player-tab:active { transform: scale(0.95); }
    .player-tab:hover { opacity: 0.9; }
    .player-tab-active {
      color: var(--text);
      box-shadow: var(--shadowSm);
    }
    .player-tab-inactive {
      background-color: var(--surface2);
      color: var(--muted);
      border: 1px solid var(--border);
    }
    .player-tab-inactive:hover {
      background-color: var(--surface2Hover);
      border-color: var(--borderAccent);
    }
    
    .standing-bar {
      height: 2.5rem;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      padding: 0 0.75rem;
      color: white;
      font-weight: 700;
      font-size: 0.875rem;
      transition: width 0.5s;
    }

    .standing-bar-end {
      height: 3.5rem;
      border-radius: 0.75rem;
      display: flex;
      align-items: center;
      padding: 0 0.75rem;
      color: white;
      font-weight: 700;
      font-size: 1rem;
      transition: width 1s ease-out;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
    }

    .winner-row {
      animation: pulse-winner 2s ease-in-out infinite;
    }

    @keyframes pulse-winner {
      0%, 100% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.02);
        opacity: 0.95;
      }
    }

    @keyframes bounce {
      0%, 100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    .animate-bounce {
      animation: bounce 1s ease-in-out infinite;
    }

    .reveal-slide-up {
      animation: slide-up 0.3s ease-out;
    }

    @keyframes slide-up {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {
      0%, 100% {
        opacity: 1;
      }
      50% {
        opacity: 0.5;
      }
    }

    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    .divider { height: 1px; background-color: var(--divider); opacity: 0.8; }
    
    .sticky { position: sticky; top: 0; z-index: 20; }
    .sticky-tabs { position: sticky; top: 2.75rem; z-index: 10; }
    
    /* Small transparent action buttons */
    .clear-btn {
      background: transparent;
      border: none;
      color: var(--error);
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      font-family: inherit;
      line-height: 1;
    }
    .clear-btn:active { transform: scale(0.9); }

    .order-btn {
      background: transparent;
      border: none;
      color: var(--text);
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      font-family: inherit;
      line-height: 1;
    }
    .order-btn:active { transform: scale(0.9); opacity: 0.7; }

    .delete-btn {
      background: transparent;
      border: none;
      color: var(--error);
      font-size: 0.875rem;
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      font-family: inherit;
      font-weight: 500;
    }
    .delete-btn:active { transform: scale(0.9); opacity: 0.7; }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: var(--tooltipBg);
      color: var(--tooltipText);
      padding: 0.75rem 1.5rem;
      border-radius: var(--rMd);
      font-weight: 600;
      z-index: 100;
      border: 1px solid var(--border);
      box-shadow: var(--shadowLg);
      animation: toast-in 0.3s ease, toast-out 0.3s ease 1.7s forwards;
    }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(-50%) translateY(1rem); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateX(-50%) translateY(0); }
      to { opacity: 0; transform: translateX(-50%) translateY(1rem); }
    }
    
    /* Current turn indicator */
    .current-turn-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.25rem;
    }
    .pulse-dot {
      width: 0.5rem;
      height: 0.5rem;
      border-radius: 50%;
      background: var(--link);
      animation: pulse 1.5s infinite;
    }
    .pulse-dot-small {
      width: 0.375rem;
      height: 0.375rem;
      border-radius: 50%;
      background: rgba(255,255,255,0.9);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.5; transform: scale(1.2); }
    }

    /* Player Carousel */
    .player-carousel-container {
      position: sticky;
      top: 2.75rem;
      z-index: 10;
      background: var(--surface);
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
      border-bottom: 1px solid var(--border);
      overflow: hidden;
      height: 7rem;
    }
    .player-carousel {
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    .player-carousel::-webkit-scrollbar {
      display: none;
    }
    .player-card {
      flex-shrink: 0;
      scroll-snap-align: start;
      border-radius: 1rem;
      padding: 1rem;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3), 0 2px 4px -1px rgba(0,0,0,0.2);
      cursor: pointer;
      transition: all 0.2s;
      color: white;
      height: 5.5rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .player-card-active {
      width: 70%;
      min-width: 16rem;
      justify-content: space-between;
    }
    .player-card-inactive {
      width: 70%;
      min-width: 16rem;
      justify-content: flex-start;
      background: var(--surface2);
      border: 1px solid var(--border);
    }
    .player-card:active {
      transform: scale(0.98);
    }
    .player-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    .player-name {
      font-size: 1.25rem;
      font-weight: 900;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .player-name-inactive {
      color: var(--text);
      text-shadow: none;
    }
    .player-card-stats {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    .stat-main {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
    }
    .stat-label {
      font-size: 0.75rem;
      opacity: 0.9;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .stat-value-large {
      font-size: 2rem;
      font-weight: 900;
      text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    .stat-row {
      display: flex;
      gap: 0.75rem;
      margin-top: 0.25rem;
    }
    .stat-item {
      flex: 1;
      background: rgba(255,255,255,0.15);
      border-radius: 0.5rem;
      padding: 0.375rem 0.5rem;
      backdrop-filter: blur(10px);
      text-align: center;
    }
    .stat-label-sm {
      font-size: 0.625rem;
      opacity: 0.85;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .stat-value-sm {
      font-size: 0.875rem;
      font-weight: 900;
      margin-top: 0.125rem;
    }

    /* Section Tabs */
    .section-tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      background: var(--surface2);
      padding: 0.375rem;
      border-radius: var(--rLg);
      border: 1px solid var(--border);
    }
    .section-tab {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.25rem;
      padding: 0.625rem 0.75rem;
      border-radius: var(--rMd);
      border: none;
      background: transparent;
      color: var(--textMuted);
      font-weight: 600;
      transition: all 0.15s;
      cursor: pointer;
    }
    .section-tab-active {
      background: var(--surface);
      color: var(--text);
      box-shadow: var(--shadowSm), var(--innerHighlight);
    }
    .section-tab-label {
      font-size: 0.875rem;
    }
    .section-tab-badge {
      font-size: 0.75rem;
      padding: 0.125rem 0.5rem;
      border-radius: var(--rPill);
      background: var(--surface2);
      color: var(--textMuted);
      font-weight: 700;
    }
    .section-tab-active .section-tab-badge {
      background: var(--link);
      color: var(--bg);
    }
    .section-tab-badge-success {
      background: var(--link) !important;
      color: var(--bg) !important;
    }

    /* Version footer */
    .version-footer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      text-align: center;
      padding: 0.25rem 0.5rem;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      font-size: 0.625rem;
      color: rgba(255, 255, 255, 0.5);
      z-index: 1000;
      font-family: monospace;
    }
    .version-footer:hover {
      color: rgba(255, 255, 255, 0.8);
    }

    /* Mode toggle styles */
    .mode-toggle {
      display: flex;
      background: var(--surface2);
      border-radius: var(--rMd);
      padding: 0.25rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }
    .mode-btn {
      flex: 1;
      padding: 0.75rem;
      border: none;
      background: transparent;
      color: var(--muted);
      font-weight: 700;
      font-size: 0.875rem;
      cursor: pointer;
      border-radius: var(--rSm);
      transition: all 0.2s;
      font-family: inherit;
    }
    .mode-btn:hover:not(.active) {
      background: var(--surfaceHover);
      color: var(--text);
    }
    .mode-btn.active {
      background: var(--accent);
      color: var(--onAccent);
      box-shadow: var(--shadowSm);
    }

    /* Dice styles */
    .dice-area {
      background: linear-gradient(135deg, var(--surface2) 0%, var(--border) 100%);
      border-radius: 1rem;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
    }
    .dice-container {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    .die {
      width: 3rem;
      height: 3rem;
      background: white;
      border-radius: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.75rem;
      font-weight: 900;
      color: var(--onAccent);
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    .die:active {
      transform: scale(0.95);
    }
    .die.held {
      background: var(--link);
      border: 3px solid var(--accent);
      box-shadow: 0 0 12px var(--focusRingStrong);
    }
    .die.held::after {
      content: 'HOLD';
      position: absolute;
      bottom: -1.25rem;
      left: 50%;
      transform: translateX(-50%);
      font-size: 0.625rem;
      font-weight: 700;
      color: var(--accent);
      white-space: nowrap;
    }
    .die.rolling {
      animation: dice-roll 0.1s ease-in-out infinite;
    }
    @keyframes dice-roll {
      0% { transform: rotate(-5deg) scale(1.05); }
      50% { transform: rotate(5deg) scale(0.95); }
      100% { transform: rotate(-5deg) scale(1.05); }
    }
    .roll-btn {
      width: 100%;
      padding: 1rem;
      background: linear-gradient(to right, var(--link), var(--linkHover));
      color: var(--bg);
      border: none;
      border-radius: 0.75rem;
      font-size: 1.125rem;
      font-weight: 700;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.15s;
    }
    .roll-btn:active {
      transform: scale(0.98);
    }
    .roll-btn:disabled {
      background: var(--border);
      color: var(--muted);
      cursor: not-allowed;
      transform: none;
    }
    .roll-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.625rem;
      color: var(--text);
    }
    .roll-count {
      font-weight: 700;
      font-size: 0.875rem;
    }
    .shake-hint {
      font-size: 0.75rem;
      opacity: 0.7;
    }

    /* Score suggestion styles */
    .score-suggestion {
      background: rgba(57, 198, 167, 0.15);
      border: 2px solid var(--link);
    }
    .score-suggestion-text {
      color: var(--link);
      font-weight: 700;
      font-size: 0.75rem;
    }

    /* Play mode category button */
    .score-btn-play {
      min-width: 4rem;
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
      font-weight: 700;
      font-size: 1.125rem;
      border: none;
      cursor: pointer;
      transition: all 0.15s;
      font-family: inherit;
    }
    .score-btn-play:active {
      transform: scale(0.95);
    }
    .score-btn-play:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .score-available {
      background: rgba(57, 198, 167, 0.15);
      color: var(--link);
      border: 2px solid var(--link);
    }
    .score-zero-only {
      background: rgba(251, 113, 133, 0.15);
      color: var(--error);
      border: 2px dashed var(--error);
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="toast"></div>
  <div id="version" class="version-footer">v1.0.0</div>

  <script>
    // Automatic version management via git hooks
    const UPPER = [
      { id: 'ones', name: 'Ones', value: 1 },
      { id: 'twos', name: 'Twos', value: 2 },
      { id: 'threes', name: 'Threes', value: 3 },
      { id: 'fours', name: 'Fours', value: 4 },
      { id: 'fives', name: 'Fives', value: 5 },
      { id: 'sixes', name: 'Sixes', value: 6 },
    ];

    const LOWER = [
      { id: 'threeOfKind', name: '3 of a Kind', type: 'sum', max: 30 },
      { id: 'fourOfKind', name: '4 of a Kind', type: 'sum', max: 30 },
      { id: 'fullHouse', name: 'Full House', type: 'fixed', fixed: 25 },
      { id: 'smallStraight', name: 'Sm. Straight', type: 'fixed', fixed: 30 },
      { id: 'largeStraight', name: 'Lg. Straight', type: 'fixed', fixed: 40 },
      { id: 'yahtzee', name: 'YAHTZEE!', type: 'fixed', fixed: 50 },
      { id: 'chance', name: 'Chance', type: 'sum', max: 30 },
    ];

    // Player colors - diverse palette for up to 8 players with clear differentiation
    const COLORS = [
      '#39C6A7',  // 1. Jade (accent) - primary brand
      '#7AE7D0',  // 2. Sky jade (link) - bright cyan
      '#F4B24A',  // 3. Amber (warning) - warm yellow
      '#FB7185',  // 4. Coral (error) - pink/salmon
      '#34D399',  // 5. Emerald (success) - bright green
      '#22D3EE',  // 6. Aqua - turquoise
      '#A78BFA',  // 7. Lavender - purple
      '#FB923C'   // 8. Peach - orange
    ];

    let S = {
      view: 'setup',
      known: JSON.parse(localStorage.getItem('yahtzeeP') || '[]'),
      game: [],
      cur: 0,
      history: JSON.parse(localStorage.getItem('yahtzeeH') || '[]'),
      savedGame: JSON.parse(localStorage.getItem('yahtzeeSaved') || 'null'),
      start: null,
      picker: null,
      mgr: false,
      stats: null,
      // Game mode: 'score' (manual entry) or 'play' (with dice)
      mode: 'score',
      // Dice state for play mode
      dice: [1, 1, 1, 1, 1],
      held: [false, false, false, false, false],
      rollCount: 0,
      rolling: false,
      turnStarted: false, // Must tap "Start Turn" before rolling
      // Shake detection
      shakeEnabled: false,
      lastShake: 0,
      // History detail view
      selectedHistoryGame: null,
      historyDetailPlayer: 0 // Currently viewed player in history detail
    };

    const save = () => { 
      localStorage.setItem('yahtzeeP', JSON.stringify(S.known)); 
      localStorage.setItem('yahtzeeH', JSON.stringify(S.history)); 
    };
    
    const saveCurrentGame = () => {
      const gameState = {
        game: S.game,
        cur: S.cur,
        start: S.start,
        savedAt: Date.now(),
        // Save play mode state
        mode: S.mode,
        dice: S.dice,
        held: S.held,
        rollCount: S.rollCount,
        turnStarted: S.turnStarted
      };
      localStorage.setItem('yahtzeeSaved', JSON.stringify(gameState));
      S.savedGame = gameState;
    };
    
    const clearSavedGame = () => {
      localStorage.removeItem('yahtzeeSaved');
      S.savedGame = null;
    };
    
    const empty = () => ({ ones:null, twos:null, threes:null, fours:null, fives:null, sixes:null, threeOfKind:null, fourOfKind:null, fullHouse:null, smallStraight:null, largeStraight:null, yahtzee:null, chance:null, bonus:0 });
    const upTot = s => ['ones','twos','threes','fours','fives','sixes'].reduce((a,c) => a+(s[c]||0), 0);
    const upBonus = s => upTot(s) >= 63 ? 35 : 0;
    const loTot = s => ['threeOfKind','fourOfKind','fullHouse','smallStraight','largeStraight','yahtzee','chance'].reduce((a,c) => a+(s[c]||0), 0) + (s.bonus||0);
    const grand = s => upTot(s) + upBonus(s) + loTot(s);
    const color = id => { const i = S.known.findIndex(p => p.id === id); return COLORS[i % COLORS.length]; };
    
    const isGameComplete = () => {
      return S.game.every(p => {
        const s = p.scores;
        return s.ones !== null && s.twos !== null && s.threes !== null &&
               s.fours !== null && s.fives !== null && s.sixes !== null &&
               s.threeOfKind !== null && s.fourOfKind !== null && s.fullHouse !== null &&
               s.smallStraight !== null && s.largeStraight !== null && s.yahtzee !== null && s.chance !== null;
      });
    };

    // Dice rolling functions
    const rollDie = () => Math.floor(Math.random() * 6) + 1;

    const rollDice = () => {
      if (!S.turnStarted || S.rolling || S.rollCount >= 3) return;

      // Haptic feedback - simple single pulse
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }

      S.rolling = true;
      R();

      // Animate for 400ms
      let animCount = 0;
      const animInterval = setInterval(() => {
        S.dice = S.dice.map((d, i) => S.held[i] ? d : rollDie());
        R();
        animCount++;
        if (animCount >= 8) {
          clearInterval(animInterval);
          S.rolling = false;
          S.rollCount++;
          R();

          // Check for Yahtzee and notify
          if (calcScore(S.dice, 'yahtzee') === 50) {
            showToast('üéâ YAHTZEE!');
            // Fun but brief celebration pattern
            if (navigator.vibrate) navigator.vibrate([100, 50, 100]);
          }
        }
      }, 50);
    };

    const toggleHold = (index) => {
      if (S.rollCount === 0 || S.rolling) return; // Can't hold before first roll
      S.held[index] = !S.held[index];

      // Very brief haptic feedback (like keyboard typing)
      if (navigator.vibrate) {
        navigator.vibrate(5);
      }

      R();
    };

    const resetDiceForTurn = () => {
      S.dice = [1, 1, 1, 1, 1];
      S.held = [false, false, false, false, false];
      S.rollCount = 0;
      S.rolling = false;
      S.turnStarted = false;
    };

    const startTurn = () => {
      S.turnStarted = true;

      // Haptic feedback when starting turn (same as roll)
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }

      R();
    };

    // Score calculation engine for play mode
    const calcScore = (dice, category) => {
      const counts = [0, 0, 0, 0, 0, 0, 0]; // index 0 unused, 1-6 for dice values
      dice.forEach(d => counts[d]++);
      const sum = dice.reduce((a, b) => a + b, 0);
      const sortedCounts = [...counts.slice(1)].sort((a, b) => b - a);
      const uniqueValues = new Set(dice);
      const sortedDice = [...dice].sort((a, b) => a - b);

      switch (category) {
        // Upper section - count specific number
        case 'ones': return counts[1] * 1;
        case 'twos': return counts[2] * 2;
        case 'threes': return counts[3] * 3;
        case 'fours': return counts[4] * 4;
        case 'fives': return counts[5] * 5;
        case 'sixes': return counts[6] * 6;

        // Three of a kind - sum of all dice if 3+ match
        case 'threeOfKind':
          return sortedCounts[0] >= 3 ? sum : 0;

        // Four of a kind - sum of all dice if 4+ match
        case 'fourOfKind':
          return sortedCounts[0] >= 4 ? sum : 0;

        // Full House - 3 of one, 2 of another = 25 points
        case 'fullHouse':
          return (sortedCounts[0] === 3 && sortedCounts[1] === 2) ? 25 : 0;

        // Small Straight - 4 consecutive = 30 points
        case 'smallStraight': {
          const patterns = [[1,2,3,4], [2,3,4,5], [3,4,5,6]];
          const hasSmall = patterns.some(p => p.every(n => uniqueValues.has(n)));
          return hasSmall ? 30 : 0;
        }

        // Large Straight - 5 consecutive = 40 points
        case 'largeStraight': {
          const isLarge = (sortedDice.join('') === '12345' || sortedDice.join('') === '23456');
          return isLarge ? 40 : 0;
        }

        // Yahtzee - all 5 same = 50 points
        case 'yahtzee':
          return sortedCounts[0] === 5 ? 50 : 0;

        // Chance - sum of all dice
        case 'chance':
          return sum;

        default:
          return 0;
      }
    };

    // Get all possible scores for current dice
    const getPossibleScores = (dice) => {
      const categories = ['ones', 'twos', 'threes', 'fours', 'fives', 'sixes',
                          'threeOfKind', 'fourOfKind', 'fullHouse',
                          'smallStraight', 'largeStraight', 'yahtzee', 'chance'];
      const scores = {};
      categories.forEach(cat => {
        scores[cat] = calcScore(dice, cat);
      });
      return scores;
    };
    
    const showToast = (msg) => {
      const toast = document.getElementById('toast');
      toast.innerHTML = '<div class="toast">' + msg + '</div>';
      setTimeout(() => { toast.innerHTML = ''; }, 2000);
    };

    function exportData() {
      const data = {
        version: 1,
        exportedAt: new Date().toISOString(),
        players: JSON.parse(localStorage.getItem('yahtzeeP') || '[]'),
        history: JSON.parse(localStorage.getItem('yahtzeeH') || '[]')
      };

      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'yahtzee-data-' + new Date().toISOString().split('T')[0] + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Data exported! üì•');
    }

    function importData(jsonString) {
      try {
        const data = JSON.parse(jsonString);

        // Validate
        if (!data.players || !Array.isArray(data.players) ||
            !data.history || !Array.isArray(data.history)) {
          throw new Error('Invalid file format');
        }

        // Load existing
        let players = JSON.parse(localStorage.getItem('yahtzeeP') || '[]');
        let history = JSON.parse(localStorage.getItem('yahtzeeH') || '[]');

        // Merge players (avoid duplicates by id)
        const existingPlayerIds = new Set(players.map(p => p.id));
        let newPlayersCount = 0;
        for (const player of data.players) {
          if (!existingPlayerIds.has(player.id)) {
            players.push(player);
            newPlayersCount++;
          }
        }

        // Merge history (avoid duplicates by id)
        const existingHistoryIds = new Set(history.map(h => h.id));
        let newHistoryCount = 0;
        for (const entry of data.history) {
          if (!existingHistoryIds.has(entry.id)) {
            history.push(entry);
            newHistoryCount++;
          }
        }

        // Sort history by date (newest first)
        history.sort((a, b) => new Date(b.date) - new Date(a.date));

        // Save
        localStorage.setItem('yahtzeeP', JSON.stringify(players));
        localStorage.setItem('yahtzeeH', JSON.stringify(history));

        // Update state
        S.known = players;
        S.history = history;

        showToast('Imported: ' + newPlayersCount + ' players, ' + newHistoryCount + ' games üì§');
        R();
      } catch (error) {
        alert('Import failed: ' + error.message);
      }
    }

    function triggerImport() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'application/json,.json';
      input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            importData(event.target.result);
          };
          reader.readAsText(file);
        }
      };
      input.click();
    }

    function R() {
      // Save carousel scroll position before re-render (to prevent jumping)
      let savedScrollLeft = 0;
      const carousel = document.getElementById('playerCarousel');
      if (carousel) {
        savedScrollLeft = carousel.scrollLeft;
      }

      const app = document.getElementById('app');
      if (S.view === 'setup') app.innerHTML = setup();
      else if (S.view === 'history') {
        if (S.selectedHistoryGame) {
          app.innerHTML = historyDetailView();
        } else {
          app.innerHTML = hist();
        }
      }
      else if (S.view === 'endScreen') {
        app.innerHTML = endScreenView();
        // Start animations after render
        setTimeout(() => {
          startFireworks();
          animateReveal();
        }, 100);
      }
      else {
        app.innerHTML = gameView();
        // Restore scroll position immediately (no animation) to prevent jumping
        const newCarousel = document.getElementById('playerCarousel');
        if (newCarousel && savedScrollLeft > 0) {
          newCarousel.scrollLeft = savedScrollLeft;
        }
      }

      // Update theme-color dynamically to match header
      updateThemeColor();
    }

    function updateThemeColor() {
      const metaThemeColor = document.querySelector('meta[name="theme-color"]');
      if (!metaThemeColor) return;

      // Get colors from CSS variables
      const styles = getComputedStyle(document.documentElement);
      const accentColor = styles.getPropertyValue('--accent').trim();
      const bgColor = styles.getPropertyValue('--bg').trim();

      // Match the header gradient color on game/history views
      if (S.view === 'setup') {
        metaThemeColor.setAttribute('content', bgColor);
      } else {
        // game and history views have header-gradient (accent color)
        metaThemeColor.setAttribute('content', accentColor);
      }
    }

    function navigateTo(view) {
      S.view = view;

      // Clear history detail state when navigating to history list
      if (view === 'history') {
        S.selectedHistoryGame = null;
        S.historyDetailPlayer = 0;
      }

      history.pushState({ view: view }, '', '#' + view);
      R();
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', (event) => {
      const previousView = S.view;
      if (event.state && event.state.view) {
        S.view = event.state.view;

        // Restore history detail state if present
        if (S.view === 'history' && event.state.gameId) {
          const game = S.history.find(h => h.id === event.state.gameId);
          if (game) {
            S.selectedHistoryGame = game;
            S.historyDetailPlayer = 0;
          }
        } else if (S.view === 'history') {
          // Clear history detail state when navigating to history list
          S.selectedHistoryGame = null;
          S.historyDetailPlayer = 0;
        }
      } else {
        // Default to setup if no state
        S.view = 'setup';
        S.selectedHistoryGame = null;
        S.historyDetailPlayer = 0;
      }

      // If going from game back to setup, clear game state to prevent cached scores
      if (previousView === 'game' && S.view === 'setup') {
        S.game = [];
        S.cur = 0;
      }

      R();
    });

    function setup() {
      const pl = S.known.length === 0
        ? '<div class="text-center py-5 text-purple-200"><p class="mb-2">No players yet!</p><button class="btn btn-small glass text-white" onclick="S.mgr=true;R()">+ Add Players</button></div>'
        : S.known.map((p,i) => {
            const sel = S.game.some(g => g.id === p.id);
            const gi = S.game.findIndex(g => g.id === p.id);
            return '<div class="flex items-center gap-2 rounded-xl p-3 '+(sel?'glass-dark':'glass')+'" style="'+(sel?'box-shadow:0 0 0 2px white;':'')+'" onclick="tog('+p.id+')">'+
              '<div class="checkbox">'+(sel?'<div class="checkbox-inner"></div>':'')+'</div>'+
              '<div class="color-dot" style="background:'+COLORS[i%COLORS.length]+'"></div>'+
              '<span class="flex-1 font-medium text-white">'+p.name+'</span>'+
              (sel?'<button class="order-btn" onclick="event.stopPropagation();mv('+gi+',-1)">‚ñ≤</button><button class="order-btn" onclick="event.stopPropagation();mv('+gi+',1)">‚ñº</button>':'')+
              '<button class="btn btn-small glass text-white text-xs" onclick="event.stopPropagation();S.stats=S.known.find(x=>x.id==='+p.id+');R()">üìä</button>'+
            '</div>';
          }).join('');

      const ord = S.game.length > 0 ? '<div class="glass rounded-xl p-3 mt-4"><p class="text-sm text-purple-200 mb-1">Play order:</p><p class="font-medium text-white">'+S.game.map(p=>p.name).join(' ‚Üí ')+'</p></div>' : '';

      const resumeBtn = S.savedGame ?
        '<button class="btn btn-resume mb-4" onclick="resumeGame()">‚ñ∂Ô∏è RESUME GAME</button>'+
        '<button class="btn btn-secondary mb-4" onclick="discardSaved()">üóëÔ∏è Discard Saved Game</button>' : '';

      const modeToggle = '<div class="mode-toggle">'+
        '<button class="mode-btn '+(S.mode==='score'?'active':'')+'" onclick="S.mode=\'score\';R()">üìù Score Only</button>'+
        '<button class="mode-btn '+(S.mode==='play'?'active':'')+'" onclick="S.mode=\'play\';R()">üé≤ Play Mode</button>'+
      '</div>';

      const modeDesc = S.mode === 'play'
        ? '<div class="glass rounded-xl p-3 mb-4"><p class="text-white text-sm font-medium">üé≤ Play Mode</p><p class="text-purple-200 text-xs mt-1">Roll dice on your phone! Shake to roll or tap the button. Scores are calculated automatically.</p></div>'
        : '<div class="glass rounded-xl p-3 mb-4"><p class="text-white text-sm font-medium">üìù Score Mode</p><p class="text-purple-200 text-xs mt-1">Use your own dice. Manually enter scores as you play.</p></div>';

      return '<div class="container" style="min-height:100vh">'+
        '<div class="text-center mb-6"><div class="text-5xl mb-2">üé≤</div><h1 class="text-4xl font-black text-white">YAHTZEE</h1><p class="text-purple-200 text-sm">Score Keeper</p></div>'+
        modeToggle+modeDesc+
        (S.savedGame ? '<div class="glass rounded-2xl p-4 mb-4"><p class="text-white font-bold mb-2">üìå Saved Game '+(S.savedGame.mode === 'play' ? 'üé≤' : 'üìù')+'</p><p class="text-purple-200 text-sm">'+S.savedGame.game.map(p=>p.name).join(', ')+'</p><p class="text-purple-200 text-xs mt-1">Saved '+new Date(S.savedGame.savedAt).toLocaleString()+'</p></div>' : '')+
        resumeBtn+
        '<div class="glass rounded-2xl p-5 mb-4">'+
          '<div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-white">Select Players</h2><button class="btn btn-small glass text-white" onclick="S.mgr=true;R()">‚öôÔ∏è Manage</button></div>'+
          '<div class="space-y-2">'+pl+'</div>'+ord+
        '</div>'+
        '<button class="btn btn-primary" onclick="start()" '+(S.game.length===0?'disabled':'')+'>'+(S.game.length===0?'Select Players':(S.mode==='play'?'üé≤ START GAME':'üìù START SCORING')+' ('+S.game.length+')')+'</button>'+
        '<button class="btn btn-secondary mt-4" onclick="navigateTo(\'history\')">üìú Game History</button>'+
        '<div class="grid grid-cols-2 gap-2 mt-4">'+
          '<button class="btn btn-secondary" onclick="exportData()">üì• Export</button>'+
          '<button class="btn btn-secondary" onclick="triggerImport()">üì§ Import</button>'+
        '</div>'+
      '</div>'+(S.mgr?mgr():'')+(S.stats?statsModal():'');
    }

    function mgr() {
      const pl = S.known.map((p,i) => 
        '<div class="flex items-center gap-2 bg-gray-50 rounded-xl p-3">'+
          '<div class="color-dot" style="background:'+COLORS[i%COLORS.length]+'"></div>'+
          '<input type="text" class="input flex-1" value="'+p.name+'" onchange="ren('+p.id+',this.value)">'+
          '<button class="delete-btn" onclick="del('+p.id+')">Delete</button>'+
        '</div>'
      ).join('');
      return '<div class="modal-overlay" onclick="S.mgr=false;save();R()"><div class="modal" onclick="event.stopPropagation()">'+
        '<h2 class="text-xl font-black text-gray-800 mb-4">üë• Manage Players</h2>'+
        '<div class="space-y-2 mb-4">'+pl+'</div>'+
        '<div class="flex gap-2 mb-4"><input type="text" id="np" class="input flex-1" placeholder="New player..." onkeypress="if(event.key===\'Enter\')addP()"><button class="btn btn-blue btn-small text-white" onclick="addP()">Add</button></div>'+
        '<button class="btn btn-green font-bold py-3 px-4 rounded-xl w-full" onclick="S.mgr=false;save();R()">Done</button>'+
      '</div></div>';
    }

    function statsModal() {
      const p = S.stats;
      const games = S.history.filter(g => g.players.some(x => x.pid === p.id));
      const res = games.map(g => g.players.find(x => x.pid === p.id)).filter(Boolean);
      const wins = games.filter(g => { const s = [...g.players].sort((a,b) => b.total - a.total); return s[0]?.pid === p.id; }).length;
      const hi = res.length ? Math.max(...res.map(r => r.total)) : 0;
      const avg = res.length ? Math.round(res.reduce((a,r) => a + r.total, 0) / res.length) : 0;
      const ytz = res.reduce((a,r) => a + (r.scores.yahtzee === 50 ? 1 : 0) + (r.scores.bonus / 100), 0);

      const st = res.length === 0
        ? '<p class="text-center text-gray-400 py-5">No games yet</p>'
        : '<div class="grid grid-cols-2 gap-3 mb-4">'+
            '<div style="background:var(--surface2);border:1px solid var(--border)" class="rounded-xl p-4 text-center"><div class="text-3xl font-black text-blue-600">'+res.length+'</div><div class="text-xs text-gray-500">Games</div></div>'+
            '<div style="background:var(--surface2);border:1px solid var(--border)" class="rounded-xl p-4 text-center"><div class="text-3xl font-black text-yellow-600">'+wins+'</div><div class="text-xs text-gray-500">Wins ('+(res.length?Math.round(wins/res.length*100):0)+'%)</div></div>'+
            '<div style="background:var(--surface2);border:1px solid var(--border)" class="rounded-xl p-4 text-center"><div class="text-3xl font-black text-green-600">'+hi+'</div><div class="text-xs text-gray-500">High Score</div></div>'+
            '<div style="background:var(--surface2);border:1px solid var(--border)" class="rounded-xl p-4 text-center"><div class="text-3xl font-black text-purple-600">'+avg+'</div><div class="text-xs text-gray-500">Average</div></div>'+
          '</div>'+
          '<div style="background:var(--surface2);border:1px solid var(--border)" class="rounded-xl p-4 text-center mb-4"><div class="text-3xl font-black text-red-500">üé≤ '+ytz+'</div><div class="text-xs text-gray-500">Yahtzees</div></div>';

      return '<div class="modal-overlay" onclick="S.stats=null;R()"><div class="modal" onclick="event.stopPropagation()">'+
        '<h2 class="text-2xl font-black text-white mb-1">'+p.name+'</h2><p class="text-gray-500 text-sm mb-4">Statistics</p>'+st+
        '<button class="btn btn-gray font-medium py-3 px-4 rounded-xl w-full" onclick="S.stats=null;R()">Close</button>'+
      '</div></div>';
    }

    function hist() {
      const g = S.history.length === 0
        ? '<div class="text-center py-5 text-purple-200"><p class="text-5xl mb-4">üìú</p><p>No games yet</p></div>'
        : S.history.map(h => {
            const sorted = [...h.players].sort((a,b) => b.total - a.total);
            const pls = sorted.map((p,i) =>
              '<div class="flex justify-between items-center '+(i===0?'text-yellow-400 font-bold':'text-white')+'">'+
                '<div class="flex items-center gap-2"><div class="color-dot-sm" style="background:'+color(p.pid)+'"></div><span>'+(i===0?'üèÜ ':'')+p.name+'</span></div>'+
                '<span class="text-lg">'+p.total+'</span>'+
              '</div>'
            ).join('');
            return '<div class="glass rounded-2xl p-4" style="cursor:pointer;transition:all 0.15s" onclick="viewHistoryGame('+h.id+')" onmouseover="this.style.background=\'rgba(255,255,255,0.15)\'" onmouseout="this.style.background=\'rgba(255,255,255,0.1)\'">'+
              '<div class="flex justify-between items-start mb-3">'+
                '<div><p class="font-bold text-white">'+new Date(h.date).toLocaleDateString()+'</p><p class="text-sm text-purple-200">'+new Date(h.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+(h.dur?' ‚Ä¢ '+h.dur+'m':'')+'</p></div>'+
                '<button class="delete-btn" onclick="event.stopPropagation();delH('+h.id+')">üóëÔ∏è</button>'+
              '</div>'+
              '<div class="space-y-2">'+pls+'</div>'+
              '<div class="text-center mt-3"><span class="text-purple-200 text-xs">üëÅÔ∏è Tap to view details</span></div>'+
            '</div>';
          }).join('');

      return '<div class="container" style="min-height:100vh">'+
        '<div class="flex items-center justify-between mb-6"><button class="btn-text text-purple-200 text-lg font-medium" onclick="navigateTo(\'setup\')">‚Üê Back</button><h1 class="text-2xl font-black text-white">üìú History</h1><div style="width:4rem"></div></div>'+
        '<div class="space-y-3">'+g+'</div>'+
      '</div>';
    }

    function viewHistoryGame(gameId) {
      const game = S.history.find(h => h.id === gameId);
      if (game) {
        S.selectedHistoryGame = game;
        S.historyDetailPlayer = 0;
        history.pushState({ view: 'history', gameId: gameId }, '', '#history-detail');
        R();
      }
    }

    function closeHistoryDetail() {
      // Use browser back instead of directly modifying state
      history.back();
    }

    function switchHistoryPlayer(index) {
      S.historyDetailPlayer = index;
      R();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function historyDetailView() {
      const game = S.selectedHistoryGame;
      if (!game) return '';

      const players = game.players;
      const cp = players[S.historyDetailPlayer];
      const sc = cp.scores;

      const tabs = players.map((p, i) =>
        '<button class="player-tab flex-shrink-0 '+(i===S.historyDetailPlayer?'player-tab-active':'player-tab-inactive')+'" style="'+(i===S.historyDetailPlayer?'background:'+color(p.pid):'')+'" onclick="switchHistoryPlayer('+i+')">'+p.name+': '+p.total+'</button>'
      ).join('');

      // Upper section - read only
      const up = UPPER.map(c => {
        const v = sc[c.id];
        return '<div class="flex items-center justify-between px-4 py-3">'+
          '<span class="font-medium text-gray-800">'+c.name+'</span>'+
          '<span class="score-btn score-filled-blue">'+(v !== null ? v : 0)+'</span>'+
        '</div><div class="divider"></div>';
      }).join('');

      // Lower section - read only
      const lo = LOWER.map(c => {
        const v = sc[c.id];
        return '<div class="flex items-center justify-between px-4 py-3">'+
          '<span class="font-medium text-gray-800">'+c.name+'</span>'+
          '<span class="score-btn score-filled-purple">'+(v !== null ? v : 0)+'</span>'+
        '</div><div class="divider"></div>';
      }).join('');

      // Standings - match end screen format
      const sortedPlayers = [...players].sort((a, b) => b.total - a.total);
      const maxScore = sortedPlayers[0].total;
      const stand = sortedPlayers.map((p, idx) => {
        const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : (idx + 1);
        const isLast = idx === sortedPlayers.length - 1;
        return '<div class="flex items-center gap-3" style="margin-bottom:'+( isLast ? '0' : '0.875rem')+'">'+
          '<span class="text-2xl" style="width:2.5rem;text-align:center">'+medal+'</span>'+
          '<div class="flex-1 rounded-xl bg-gray-100 overflow-hidden" style="height:3.5rem">'+
            '<div class="standing-bar-end" style="background:'+color(p.pid)+';width:'+Math.max(30, (p.total / maxScore) * 100)+'%">'+
              '<span class="font-bold text-white px-3">'+p.name+'</span>'+
            '</div>'+
          '</div>'+
          '<span class="font-black text-2xl" style="width:4.5rem;text-align:right;padding-right:0.5rem;color:'+color(p.pid)+'">'+p.total+'</span>'+
        '</div>';
      }).join('');

      return '<div style="min-height:100vh;background:var(--bg);padding-bottom:6rem">'+
        '<div class="header-gradient text-white p-3 sticky"><div class="flex justify-between items-center" style="max-width:28rem;margin:0 auto">'+
          '<button class="btn-text text-white text-lg font-medium" onclick="closeHistoryDetail()">‚Üê Back</button>'+
          '<h1 class="font-black text-lg">üìñ GAME REVIEW</h1>'+
          '<div class="text-xs" style="opacity:0.8">Read Only</div>'+
        '</div></div>'+
        '<div class="sticky-tabs" style="background:var(--surface);box-shadow:0 4px 6px -1px rgba(0,0,0,0.3);border-bottom:1px solid var(--border)"><div class="flex overflow-x-auto py-2 px-2 gap-2" style="max-width:28rem;margin:0 auto">'+tabs+'</div></div>'+
        '<div class="p-3" style="max-width:28rem;margin:0 auto">'+
          '<div class="card p-4 mb-4" style="border-left:4px solid '+color(cp.pid)+'">'+
            '<h2 class="font-black text-2xl" style="color:'+color(cp.pid)+'">'+cp.name+'</h2>'+
            '<p class="text-gray-500 text-sm mt-1">Final Score: '+cp.total+'</p>'+
          '</div>'+
          '<div class="glass rounded-xl p-3 mb-4 text-center">'+
            '<p class="text-white text-sm font-medium">'+new Date(game.date).toLocaleDateString()+' ‚Ä¢ '+new Date(game.date).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})+(game.dur?' ‚Ä¢ '+game.dur+' minutes':'')+'</p>'+
          '</div>'+
          '<div class="card mb-4">'+
            '<div class="upper-gradient text-white px-4 py-3 flex justify-between items-center"><span class="font-bold">Upper Section</span><span class="text-sm px-2 py-1 rounded-full '+(upTot(sc)>=63?'glass" style="background:var(--link);color:var(--bg)':'glass')+'">'+upTot(sc)+'/63</span></div>'+
            up+
            '<div class="flex items-center justify-between px-4 py-3" style="background:var(--surface2);border-top:1px solid var(--border)"><span class="font-bold text-blue-600">Upper Bonus</span><span class="font-black text-xl '+(upBonus(sc)?'text-green-600':'text-gray-400')+'">'+(upBonus(sc)?'+35 ‚úì':'0')+'</span></div>'+
          '</div>'+
          '<div class="card mb-4">'+
            '<div class="lower-gradient text-white px-4 py-3 font-bold">Lower Section</div>'+
            lo+
            '<div class="flex items-center justify-between px-4 py-3" style="background:var(--surface2);border-top:1px solid var(--border)">'+
              '<div><span class="font-bold text-yellow-600">Yahtzee Bonus</span><span class="text-yellow-600 text-xs ml-2">+100 each</span></div>'+
              '<span class="font-black text-xl text-yellow-600">+'+(sc.bonus || 0)+'</span>'+
            '</div>'+
          '</div>'+
          '<div class="total-gradient text-white rounded-2xl shadow-lg p-5 mb-4"><div class="flex justify-between items-center">'+
            '<div><p style="opacity:0.7" class="text-sm">Grand Total</p><p class="text-4xl font-black">'+cp.total+'</p></div>'+
            '<div class="text-sm" style="text-align:right;opacity:0.7"><p>Upper: '+upTot(sc)+' + '+upBonus(sc)+'</p><p>Lower: '+loTot(sc)+'</p></div>'+
          '</div></div>'+
          '<div class="card p-4"><h3 class="font-bold mb-4 text-gray-800">üìä Final Standings</h3>'+stand+'</div>'+
        '</div>'+
      '</div>';
    }

    // Dice face display using dots
    const dieFace = (value) => {
      const dots = {
        1: '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:10px;height:10px;background:var(--onAccent);border-radius:50%"></div>',
        2: '<div style="position:absolute;top:20%;left:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;bottom:20%;right:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div>',
        3: '<div style="position:absolute;top:20%;left:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;bottom:20%;right:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div>',
        4: '<div style="position:absolute;top:20%;left:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;top:20%;right:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;bottom:20%;left:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;bottom:20%;right:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div>',
        5: '<div style="position:absolute;top:20%;left:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;top:20%;right:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;bottom:20%;left:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;bottom:20%;right:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div>',
        6: '<div style="position:absolute;top:20%;left:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;top:20%;right:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;top:50%;left:20%;transform:translateY(-50%);width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;top:50%;right:20%;transform:translateY(-50%);width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;bottom:20%;left:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div><div style="position:absolute;bottom:20%;right:20%;width:8px;height:8px;background:var(--onAccent);border-radius:50%"></div>'
      };
      return dots[value] || '';
    };

    function gameView() {
      const cp = S.game[S.cur];
      const sc = cp.scores;
      const isPlayMode = S.mode === 'play';
      const possibleScores = isPlayMode && S.rollCount > 0 ? getPossibleScores(S.dice) : {};
      const canSelectScore = isPlayMode && S.rollCount > 0 && !S.rolling;

      // Initialize score section view if not set
      if (S.scoreSection === undefined) S.scoreSection = 'upper';

      // New player cards carousel
      const playerCards = S.game.map((p,i) => {
        const isCurrent = i === S.cur;

        if (!isCurrent) {
          // Inactive players - neutral background with colored left border accent
          return '<div class="player-card player-card-inactive" style="border-left:4px solid '+color(p.id)+'" onclick="switchPlayer('+i+')">' +
            '<div class="player-card-header">' +
              '<h3 class="player-name player-name-inactive">'+p.name+'</h3>' +
            '</div>' +
          '</div>';
        }

        // Active player - show full stats
        const pScores = p.scores;
        const grandTotal = grand(pScores);

        return '<div class="player-card player-card-active" style="background:linear-gradient(135deg, '+color(p.id)+' 0%, '+color(p.id)+'dd 100%)" onclick="showPlayerDetails()">' +
          '<div class="player-card-header">' +
            '<h3 class="player-name">'+p.name+'</h3>' +
            '<div class="pulse-dot-small"></div>' +
          '</div>' +
          '<div class="player-card-stats">' +
            '<div class="stat-main">' +
              '<div class="stat-label">Total</div>' +
              '<div class="stat-value-large">'+grandTotal+'</div>' +
            '</div>' +
          '</div>' +
        '</div>';
      }).join('');

      // Dice area for play mode
      const diceArea = isPlayMode ? '<div class="dice-area">'+
        (S.turnStarted ?
          // Turn started - show dice and roll button
          '<div class="roll-info">'+
            '<span class="roll-count">'+(S.rollCount === 0 ? 'Roll to start!' : 'Roll '+S.rollCount+' of 3')+'</span>'+
            '<span class="shake-hint">'+(S.shakeEnabled ? 'üì≥ Shake enabled' : 'Tap button to roll')+'</span>'+
          '</div>'+
          '<div class="dice-container">'+
            S.dice.map((d, i) =>
              '<div class="die '+(S.held[i]?'held':'')+(S.rolling && !S.held[i]?' rolling':'')+'" onclick="toggleHold('+i+')">'+dieFace(d)+'</div>'
            ).join('')+
          '</div>'+
          '<button class="roll-btn" onclick="rollDice()" '+(S.rollCount >= 3 || S.rolling ? 'disabled' : '')+'>'+
            (S.rollCount === 0 ? 'üé≤ Roll Dice!' : S.rollCount >= 3 ? 'Select a score below' : 'üé≤ Roll Again ('+S.rollCount+'/3)')+
          '</button>'+
          (S.rollCount > 0 && !S.rolling ? '<p class="text-center text-xs" style="color:rgba(255,255,255,0.6);margin-top:0.5rem">Tap dice to hold/release</p>' : '')
        :
          // Turn not started - show start button
          '<div class="text-center py-4">'+
            '<p class="text-white text-lg font-bold mb-2">Ready to roll?</p>'+
            '<p class="text-white text-xs mb-4" style="opacity:0.7">Tap the button when you\'re ready</p>'+
            '<button class="roll-btn" onclick="startTurn()">'+
              'üëÜ Start My Turn'+
            '</button>'+
          '</div>'
        )+
      '</div>' : '';

      // Score buttons for play mode vs score mode
      const up = UPPER.map(c => {
        const v = sc[c.id];
        const possible = possibleScores[c.id];
        const canSelect = canSelectScore && v === null;

        if (isPlayMode) {
          // Play mode - show calculated scores
          if (v !== null) {
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-800">'+c.name+'</span>'+
              '<div class="flex items-center gap-2">'+
                '<button class="clear-btn" onclick="clr(\''+c.id+'\')">‚úï</button>'+
                '<span class="score-btn score-filled-blue">'+v+'</span>'+
              '</div>'+
            '</div><div class="divider"></div>';
          } else if (canSelect) {
            const btnClass = possible > 0 ? 'score-available' : 'score-zero-only';
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-800">'+c.name+'</span>'+
              '<button class="score-btn-play '+btnClass+'" onclick="selectPlayScore(\''+c.id+'\','+possible+')">'+possible+'</button>'+
            '</div><div class="divider"></div>';
          } else {
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-400">'+c.name+'</span>'+
              '<span class="score-btn score-empty">-</span>'+
            '</div><div class="divider"></div>';
          }
        } else {
          // Score mode - original behavior
          return '<div class="flex items-center justify-between px-4 py-3">'+
            '<div class="flex-1"><span class="font-medium text-gray-800">'+c.name+'</span><span class="text-xs text-gray-400 ml-2">('+[0,1,2,3,4,5].map(n=>n*c.value).join(',')+')</span></div>'+
            '<div class="flex items-center gap-2">'+
              (v!==null?'<button class="clear-btn" onclick="clr(\''+c.id+'\')">‚úï</button>':'')+
              '<button class="score-btn '+(v!==null?'score-filled-blue':'score-empty')+'" onclick="openUp(\''+c.id+'\','+c.value+',\''+c.name+'\')">'+(v!==null?v:'Tap')+'</button>'+
            '</div>'+
          '</div><div class="divider"></div>';
        }
      }).join('');

      const lo = LOWER.map(c => {
        const v = sc[c.id];
        const possible = possibleScores[c.id];
        const canSelect = canSelectScore && v === null;

        if (isPlayMode) {
          // Play mode - show calculated scores
          if (v !== null) {
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-800">'+c.name+'</span>'+
              '<div class="flex items-center gap-2">'+
                '<button class="clear-btn" onclick="clr(\''+c.id+'\')">‚úï</button>'+
                '<span class="score-btn score-filled-purple">'+v+'</span>'+
              '</div>'+
            '</div><div class="divider"></div>';
          } else if (canSelect) {
            const btnClass = possible > 0 ? 'score-available' : 'score-zero-only';
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-800">'+c.name+'</span>'+
              '<button class="score-btn-play '+btnClass+'" onclick="selectPlayScore(\''+c.id+'\','+possible+')">'+possible+'</button>'+
            '</div><div class="divider"></div>';
          } else {
            return '<div class="flex items-center justify-between px-4 py-3">'+
              '<span class="font-medium text-gray-400">'+c.name+'</span>'+
              '<span class="score-btn score-empty">-</span>'+
            '</div><div class="divider"></div>';
          }
        } else {
          // Score mode - original behavior
          return '<div class="flex items-center justify-between px-4 py-3">'+
            '<div class="flex-1"><span class="font-medium text-gray-800">'+c.name+'</span><span class="text-xs text-gray-400 ml-2">'+(c.type==='fixed'?'(0/'+c.fixed+')':'(0-'+c.max+')')+'</span></div>'+
            '<div class="flex items-center gap-2">'+
              (v!==null?'<button class="clear-btn" onclick="clr(\''+c.id+'\')">‚úï</button>':'')+
              '<button class="score-btn '+(v!==null?'score-filled-purple':'score-empty')+'" onclick="openLo(\''+c.id+'\',\''+c.type+'\','+(c.fixed||c.max)+',\''+c.name+'\')">'+(v!==null?v:'Tap')+'</button>'+
            '</div>'+
          '</div><div class="divider"></div>';
        }
      }).join('');

      const gameComplete = isGameComplete();

      // Yahtzee bonus section - handle both modes
      const yahtzeeBonus = isPlayMode
        ? '<div class="flex items-center justify-between px-4 py-3 bg-yellow-50">'+
            '<div><span class="font-bold text-yellow-800">Yahtzee Bonus</span><span class="text-yellow-600 text-xs ml-2">+100 each</span></div>'+
            '<span class="font-black text-xl text-yellow-600">+'+sc.bonus+'</span>'+
          '</div>'
        : '<div class="flex items-center justify-between px-4 py-3 bg-yellow-50">'+
            '<div><span class="font-bold text-yellow-800">Yahtzee Bonus</span><span class="text-yellow-600 text-xs ml-2">+100 each</span></div>'+
            '<div class="flex items-center gap-2"><span class="font-black text-xl text-yellow-600">+'+sc.bonus+'</span><button class="btn btn-small '+(sc.yahtzee===50?'btn-yellow':'btn-gray-dark')+' font-bold" onclick="addBonus()" '+(sc.yahtzee!==50?'disabled':'')+'>+100</button></div>'+
          '</div>';

      // Section toggle tabs for scores
      const sectionTabs = '<div class="section-tabs">'+
        '<button class="section-tab '+(S.scoreSection==='upper'?'section-tab-active':'')+'" onclick="S.scoreSection=\'upper\';R()">'+
          '<span class="section-tab-label">Upper Section</span>'+
          '<span class="section-tab-badge '+(upTot(sc)>=63?'section-tab-badge-success':'')+'">'+upTot(sc)+'/63</span>'+
        '</button>'+
        '<button class="section-tab '+(S.scoreSection==='lower'?'section-tab-active':'')+'" onclick="S.scoreSection=\'lower\';R()">'+
          '<span class="section-tab-label">Lower Section</span>'+
          '<span class="section-tab-badge">'+loTot(sc)+'</span>'+
        '</button>'+
      '</div>';

      // Show only selected section
      const scoreSection = S.scoreSection === 'upper'
        ? '<div class="card score-section-card">'+
            up+
            '<div class="flex items-center justify-between px-4 py-3" style="background:var(--surface2);border-top:1px solid var(--border)"><span class="font-bold text-blue-600">Upper Bonus</span><span class="font-black text-xl '+(upBonus(sc)?'text-green-600':'text-gray-400')+'">'+(upBonus(sc)?'+35 ‚úì':'0')+'</span></div>'+
          '</div>'
        : '<div class="card score-section-card">'+
            lo+
            yahtzeeBonus+
          '</div>';

      return '<div style="min-height:100vh;background:var(--bg);padding-bottom:6rem">'+
        '<div class="header-gradient text-white p-3 sticky"><div class="flex justify-between items-center" style="max-width:28rem;margin:0 auto">'+
          '<button class="btn-text text-white text-lg font-medium" onclick="pauseG()">‚Üê Back</button>'+
          '<h1 class="font-black text-lg">'+(isPlayMode?'üé≤ YAHTZEE':'üìù SCORING')+'</h1>'+
          '<button class="btn btn-small btn-green" onclick="finishG()">Finish ‚úì</button>'+
        '</div></div>'+
        '<div class="player-carousel-container">'+
          '<div class="player-carousel" id="playerCarousel">'+playerCards+'</div>'+
        '</div>'+
        '<div class="p-3" style="max-width:28rem;margin:0 auto">'+
          diceArea+
          sectionTabs+
          scoreSection+
        '</div>'+
      '</div>'+(S.picker?picker():'')+(S.finishModal?finishConfirmModal():'')+(S.earlyFinishModal?earlyFinishModal():'')+(S.playerDetailsModal?playerDetailsModal():'');
    }

    function showPlayerDetails() {
      S.playerDetailsModal = true;
      R();
    }

    function playerDetailsModal() {
      const cp = S.game[S.cur];
      const sc = cp.scores;
      const upperTotal = upTot(sc);
      const upperBonusVal = upBonus(sc);
      const lowerTotal = loTot(sc);
      const grandTotal = grand(sc);
      const filledScores = Object.keys(sc).filter(k => k !== 'bonus' && sc[k] !== null).length;
      const totalScores = UPPER.length + LOWER.length;

      return '<div class="modal-overlay" onclick="S.playerDetailsModal=false;R()"><div class="modal" onclick="event.stopPropagation()" style="background:linear-gradient(135deg, '+color(cp.id)+' 0%, '+color(cp.id)+'dd 100%);color:white;border:none">'+
        '<button class="btn-text text-white text-sm" style="position:absolute;top:1rem;right:1rem;opacity:0.8" onclick="S.playerDetailsModal=false;R()">‚úï</button>'+
        '<div class="text-center mb-6">'+
          '<h3 class="text-3xl font-black mb-2">'+cp.name+'</h3>'+
          '<p class="text-white" style="opacity:0.8">Player Details</p>'+
        '</div>'+
        '<div class="flex flex-col gap-4" style="background:rgba(255,255,255,0.1);border-radius:1rem;padding:1.5rem;backdrop-filter:blur(10px)">'+
          '<div class="flex justify-between items-center">'+
            '<span class="text-white" style="opacity:0.9">Grand Total</span>'+
            '<span class="text-4xl font-black">'+grandTotal+'</span>'+
          '</div>'+
          '<div class="divider" style="background:rgba(255,255,255,0.2)"></div>'+
          '<div class="flex justify-between items-center">'+
            '<span class="text-white" style="opacity:0.9">Upper Section</span>'+
            '<span class="text-2xl font-bold">'+upperTotal+'</span>'+
          '</div>'+
          '<div class="flex justify-between items-center">'+
            '<span class="text-white" style="opacity:0.9;padding-left:1rem">Base Score</span>'+
            '<span class="text-xl">'+upperTotal+'</span>'+
          '</div>'+
          '<div class="flex justify-between items-center">'+
            '<span class="text-white" style="opacity:0.9;padding-left:1rem">Bonus</span>'+
            '<span class="text-xl">'+(upperBonusVal?'+35 ‚úì':'0')+'</span>'+
          '</div>'+
          '<div class="divider" style="background:rgba(255,255,255,0.2)"></div>'+
          '<div class="flex justify-between items-center">'+
            '<span class="text-white" style="opacity:0.9">Lower Section</span>'+
            '<span class="text-2xl font-bold">'+lowerTotal+'</span>'+
          '</div>'+
          '<div class="flex justify-between items-center">'+
            '<span class="text-white" style="opacity:0.9;padding-left:1rem">Yahtzee Bonus</span>'+
            '<span class="text-xl">+'+(sc.bonus||0)+'</span>'+
          '</div>'+
          '<div class="divider" style="background:rgba(255,255,255,0.2)"></div>'+
          '<div class="flex justify-between items-center">'+
            '<span class="text-white" style="opacity:0.9">Progress</span>'+
            '<span class="text-xl font-bold">'+filledScores+'/'+totalScores+'</span>'+
          '</div>'+
        '</div>'+
      '</div></div>';
    }

    function finishConfirmModal() {
      return '<div class="modal-overlay" onclick="event.stopPropagation()"><div class="modal" onclick="event.stopPropagation()">'+
        '<div class="text-center mb-4">'+
          '<div class="text-5xl mb-3">üéâ</div>'+
          '<h3 class="text-2xl font-black text-gray-800 mb-2">Game Complete!</h3>'+
          '<p class="text-gray-600">All scores have been entered.</p>'+
        '</div>'+
        '<div class="flex flex-col gap-3">'+
          '<button class="btn btn-green font-bold py-4 px-4 rounded-xl w-full text-lg" onclick="confirmFinish()">üèÜ Reveal Winners!</button>'+
          '<button class="btn btn-gray font-medium py-3 px-4 rounded-xl w-full" onclick="S.finishModal=false;R()">Keep Playing</button>'+
        '</div>'+
      '</div></div>';
    }

    function earlyFinishModal() {
      const emptyCount = S.game.reduce((sum, p) => {
        const scores = p.scores;
        return sum + Object.keys(scores).filter(k => k !== 'bonus' && scores[k] === null).length;
      }, 0);

      return '<div class="modal-overlay" onclick="event.stopPropagation()"><div class="modal" onclick="event.stopPropagation()">'+
        '<div class="text-center mb-4">'+
          '<div class="text-5xl mb-3">‚ö†Ô∏è</div>'+
          '<h3 class="text-2xl font-black text-gray-800 mb-2">Game Not Complete</h3>'+
          '<p class="text-gray-600 mb-2">There are still <span class="font-bold text-red-600">'+emptyCount+' empty scores</span>.</p>'+
          '<p class="text-gray-500 text-sm">Are you sure you want to finish early?</p>'+
        '</div>'+
        '<div class="flex flex-col gap-3">'+
          '<button class="btn btn-orange font-bold py-4 px-4 rounded-xl w-full text-lg" onclick="confirmEarlyFinish()">Finish Anyway</button>'+
          '<button class="btn btn-gray font-medium py-3 px-4 rounded-xl w-full" onclick="S.earlyFinishModal=false;R()">Keep Playing</button>'+
        '</div>'+
      '</div></div>';
    }

    function confirmEarlyFinish() {
      // Fill remaining null scores with 0
      S.game.forEach(p => {
        Object.keys(p.scores).forEach(k => {
          if (k !== 'bonus' && p.scores[k] === null) {
            p.scores[k] = 0;
          }
        });
      });

      // Haptic feedback
      if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
      }

      S.earlyFinishModal = false;
      S.finishModal = true;
      R();
    }

    function picker() {
      const c = S.picker;
      if (c.t === 'upper') {
        const btns = [0,1,2,3,4,5].map(n => 
          '<button class="picker-btn" onclick="sel('+n*c.v+')"><div class="text-2xl font-black text-blue-600">'+n*c.v+'</div><div class="text-xs text-gray-500">'+n+' √ó '+c.v+'</div></button>'
        ).join('');
        return '<div class="modal-overlay" onclick="S.picker=null;R()"><div class="modal" onclick="event.stopPropagation()">'+
          '<div class="text-center mb-4"><h3 class="text-xl font-black text-gray-800">'+c.name+'</h3><p class="text-blue-600 text-sm mt-1">How many '+c.v+'s did you roll?</p></div>'+
          '<div class="grid grid-cols-3 gap-2 mb-4">'+btns+'</div>'+
          '<button class="btn btn-gray font-medium py-3 px-4 rounded-xl w-full" onclick="S.picker=null;R()">Cancel</button>'+
        '</div></div>';
      } else if (c.t === 'fixed') {
        return '<div class="modal-overlay" onclick="S.picker=null;R()"><div class="modal" onclick="event.stopPropagation()">'+
          '<div class="text-center mb-4"><h3 class="text-xl font-black text-gray-800">'+c.name+'</h3></div>'+
          '<div class="grid grid-cols-2 gap-3 mb-4">'+
            '<button class="picker-btn-green p-4" onclick="sel('+c.v+')"><div class="text-3xl font-black text-green-600">‚úì '+c.v+'</div><div class="text-sm text-green-700 font-medium">Got it!</div></button>'+
            '<button class="picker-btn-red p-4" onclick="sel(0)"><div class="text-3xl font-black text-red-400">‚úó 0</div><div class="text-sm text-red-500 font-medium">Missed</div></button>'+
          '</div>'+
          '<button class="btn btn-gray font-medium py-3 px-4 rounded-xl w-full" onclick="S.picker=null;R()">Cancel</button>'+
        '</div></div>';
      } else {
        const quick = [5,10,15,20,25,30].map(n => '<button class="picker-btn-purple text-purple-700 font-bold text-sm" onclick="sel('+n+')">'+n+'</button>').join('');
        return '<div class="modal-overlay" onclick="S.picker=null;R()"><div class="modal" onclick="event.stopPropagation()">'+
          '<div class="text-center mb-4"><h3 class="text-xl font-black text-gray-800">'+c.name+'</h3><p class="text-purple-600 text-xs mt-1">Sum of all dice (5-30)</p></div>'+
          '<button class="picker-btn-red w-full mb-3 p-3" onclick="sel(0)"><span class="font-black text-red-500">‚úó Score 0</span></button>'+
          '<p class="text-xs text-gray-400 mb-2 text-center">Quick select:</p>'+
          '<div class="grid grid-cols-6 gap-1 mb-3">'+quick+'</div>'+
          '<div class="flex gap-2 mb-4"><input type="number" id="cust" min="5" max="30" class="input flex-1 text-center text-xl font-bold" placeholder="Custom..."><button class="btn btn-purple font-bold py-3 px-4 rounded-xl" onclick="subCust()">‚úì</button></div>'+
          '<button class="btn btn-gray font-medium py-3 px-4 rounded-xl w-full" onclick="S.picker=null;R()">Cancel</button>'+
        '</div></div>';
      }
    }

    function tog(id) {
      const p = S.known.find(x => x.id === id);
      const ex = S.game.find(x => x.id === id);
      if (ex) S.game = S.game.filter(x => x.id !== id);
      else if (S.game.length < 8) S.game.push({...p, scores: empty()});
      R();
    }

    function mv(i, d) {
      const ni = i + d;
      if (ni < 0 || ni >= S.game.length) return;
      const t = S.game[i];
      S.game[i] = S.game[ni];
      S.game[ni] = t;
      R();
    }

    function addP() {
      const inp = document.getElementById('np');
      if (inp && inp.value.trim()) {
        S.known.push({id: Date.now(), name: inp.value.trim()});
        inp.value = '';
        save();
        R();
      }
    }

    function ren(id, name) {
      const p = S.known.find(x => x.id === id);
      if (p && name.trim()) p.name = name.trim();
      save();
    }

    function del(id) {
      if (confirm('Delete player?')) {
        S.known = S.known.filter(x => x.id !== id);
        S.game = S.game.filter(x => x.id !== id);
        save();
        R();
      }
    }

    function start() {
      if (S.game.length === 0) return;
      S.start = Date.now();
      S.cur = 0;
      clearSavedGame();

      // Reset dice state for play mode
      if (S.mode === 'play') {
        resetDiceForTurn();
        setupShakeDetection();
      }

      navigateTo('game');
    }

    // Select score in play mode
    function selectPlayScore(categoryId, score) {
      const cp = S.game[S.cur];

      // Handle Yahtzee bonus: if rolling another Yahtzee and first was scored (not 0)
      if (calcScore(S.dice, 'yahtzee') === 50 && cp.scores.yahtzee === 50) {
        cp.scores.bonus += 100;
        showToast('YAHTZEE BONUS! +100');
      }

      // Set the score
      cp.scores[categoryId] = score;

      // Check if game is now complete
      if (isGameComplete()) {
        // Game just finished! Show celebration modal
        if (navigator.vibrate) {
          navigator.vibrate([100, 50, 100, 50, 200]); // Celebration vibration
        }
        resetDiceForTurn();
        saveCurrentGame();
        S.finishModal = true;
        R();
        return;
      }

      // Move to next player
      const nextPlayer = (S.cur + 1) % S.game.length;
      const nextPlayerName = S.game[nextPlayer].name;
      S.cur = nextPlayer;

      // Reset dice for next turn
      resetDiceForTurn();

      // Save game state AFTER moving to next player and resetting dice
      saveCurrentGame();

      R();
      // Scroll to top to show dice area and current player
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showToast(nextPlayerName + "'s turn");
    }

    // Shake detection setup
    function setupShakeDetection() {
      const SHAKE_THRESHOLD = 20;
      const SHAKE_COOLDOWN = 2000; // 2 seconds between shakes to prevent accidental double-rolls

      // Check if DeviceMotionEvent is available
      if (!('DeviceMotionEvent' in window)) {
        S.shakeEnabled = false;
        return;
      }

      // iOS 13+ requires permission
      if (typeof DeviceMotionEvent.requestPermission === 'function') {
        // Request permission on first interaction
        const requestMotionPermission = async () => {
          try {
            const permission = await DeviceMotionEvent.requestPermission();
            if (permission === 'granted') {
              S.shakeEnabled = true;
              addShakeListener();
              R();
            }
          } catch (e) {
            console.log('Motion permission denied:', e);
          }
          // Remove this listener after first attempt
          document.removeEventListener('click', requestMotionPermission);
        };
        document.addEventListener('click', requestMotionPermission, { once: true });
        showToast('Tap anywhere to enable shake');
      } else {
        // Non-iOS or older iOS - just add listener
        S.shakeEnabled = true;
        addShakeListener();
      }

      function addShakeListener() {
        window.addEventListener('devicemotion', (e) => {
          if (S.view !== 'game' || S.mode !== 'play') return;
          if (!S.turnStarted || S.rolling || S.rollCount >= 3) return;

          const acc = e.accelerationIncludingGravity;
          if (!acc) return;

          const total = Math.sqrt(
            (acc.x || 0) ** 2 +
            (acc.y || 0) ** 2 +
            (acc.z || 0) ** 2
          );

          const now = Date.now();
          // Subtract gravity (~9.8) and check threshold
          if (total > SHAKE_THRESHOLD && now - S.lastShake > SHAKE_COOLDOWN) {
            S.lastShake = now;
            rollDice();
          }
        });
      }
    }
    
    function resumeGame() {
      if (S.savedGame) {
        S.game = S.savedGame.game;
        S.cur = S.savedGame.cur;
        S.start = S.savedGame.start;
        // Restore play mode state
        if (S.savedGame.mode) {
          S.mode = S.savedGame.mode;
          S.dice = S.savedGame.dice || [1, 1, 1, 1, 1];
          S.held = S.savedGame.held || [false, false, false, false, false];
          S.rollCount = S.savedGame.rollCount || 0;
          S.turnStarted = S.savedGame.turnStarted || false;
          if (S.mode === 'play') {
            setupShakeDetection();
          }
        }
        showToast('Game resumed!');
        navigateTo('game');
      }
    }
    
    function discardSaved() {
      if (confirm('Discard saved game?')) {
        clearSavedGame();
        // Clear the current game state to prevent cached scores
        S.game = [];
        S.cur = 0;
        R();
      }
    }

    function delH(id) {
      if (confirm('Delete game?')) {
        S.history = S.history.filter(x => x.id !== id);
        save();
        R();
      }
    }

    function scrollCarouselToActive() {
      const carousel = document.getElementById('playerCarousel');
      if (!carousel) return;

      const activeCard = carousel.querySelector('.player-card-active');
      if (activeCard) {
        activeCard.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'start' });
      }
    }

    function next() {
      // Save current scroll position before switching
      const carousel = document.getElementById('playerCarousel');
      const savedScrollLeft = carousel ? carousel.scrollLeft : 0;

      S.cur = (S.cur + 1) % S.game.length;
      R();

      // Ensure scroll is restored before animating
      requestAnimationFrame(() => {
        const newCarousel = document.getElementById('playerCarousel');
        if (newCarousel && savedScrollLeft > 0) {
          // First restore the previous scroll position instantly
          newCarousel.scrollLeft = savedScrollLeft;
        }
        // Then smoothly scroll to the new active player
        requestAnimationFrame(() => {
          scrollCarouselToActive();
        });
      });
    }

    function switchPlayer(index) {
      if (index === S.cur) return; // Already on this player

      // Save current scroll position before switching
      const carousel = document.getElementById('playerCarousel');
      const savedScrollLeft = carousel ? carousel.scrollLeft : 0;

      // In play mode, reset dice when switching players
      if (S.mode === 'play') {
        resetDiceForTurn();
      }

      S.cur = index;
      saveCurrentGame();
      R();

      // Ensure scroll is restored before animating
      requestAnimationFrame(() => {
        const newCarousel = document.getElementById('playerCarousel');
        if (newCarousel && savedScrollLeft > 0) {
          // First restore the previous scroll position instantly
          newCarousel.scrollLeft = savedScrollLeft;
        }
        // Then smoothly scroll to the new active player
        requestAnimationFrame(() => {
          scrollCarouselToActive();
        });
      });

      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function openUp(id, v, name) { S.picker = {id, v, name, t: 'upper'}; R(); }
    function openLo(id, type, v, name) { S.picker = {id, v, name, t: type}; R(); }

    function sel(v) {
      S.game[S.cur].scores[S.picker.id] = v;
      S.picker = null;

      // Check if game is now complete
      if (isGameComplete()) {
        // Game just finished! Show celebration modal
        if (navigator.vibrate) {
          navigator.vibrate([100, 50, 100, 50, 200]); // Celebration vibration
        }
        saveCurrentGame();
        S.finishModal = true;
        R();
        return;
      }

      // Auto-advance to next player
      const nextPlayer = (S.cur + 1) % S.game.length;
      const nextPlayerName = S.game[nextPlayer].name;
      S.cur = nextPlayer;

      // Auto-save game state AFTER advancing to next player
      saveCurrentGame();

      R();
      // Scroll to top to show current player and scores
      window.scrollTo({ top: 0, behavior: 'smooth' });
      showToast(nextPlayerName + "'s turn");
    }

    function subCust() {
      const inp = document.getElementById('cust');
      const v = parseInt(inp.value);
      if (v >= 0 && v <= 30) sel(v);
    }

    function clr(id) { 
      S.game[S.cur].scores[id] = null; 
      saveCurrentGame();
      R(); 
    }

    function endScreenView() {
      if (!S.finishedGame) {
        navigateTo('setup');
        return '';
      }

      const players = S.finishedGame.players.sort((a, b) => b.total - a.total);
      const maxScore = players[0].total;
      const winners = players.filter(p => p.total === maxScore);

      // Determine what to show
      const isRevealing = !S.revealComplete;
      const visibleCount = S.revealComplete ? players.length : Math.max(0, S.revealIndex + 1);

      // Winner announcement - fade in when complete
      const winnerOpacity = S.revealComplete ? '1' : '0';
      const winnerSection = winners.length === 1
        ? `<div class="text-4xl font-black mb-2 text-white" style="text-shadow:0 2px 4px rgba(0,0,0,0.2)">${winners[0].name}</div><div class="text-xl text-white" style="opacity:0.9">is the Champion!</div>`
        : `<div class="text-3xl font-black mb-2 text-white" style="text-shadow:0 2px 4px rgba(0,0,0,0.2)">It's a Tie!</div><div class="text-lg text-white" style="opacity:0.9">${winners.map(w => w.name).join(' & ')}</div>`;

      // Build ALL player slots upfront (reserve space)
      const standings = players.map((p, idx) => {
        const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : (idx + 1);
        const isWinner = p.total === maxScore;
        const isVisible = idx < visibleCount;
        const isLast = idx === players.length - 1;

        return `<div class="flex items-center gap-3 ${isWinner && S.revealComplete ? 'winner-row' : ''}" style="opacity:${isVisible ? '1' : '0'};transition:opacity 0.4s ease-out;margin-bottom:${isLast ? '0' : '0.875rem'}">
          <span class="text-2xl" style="width:2.5rem;text-align:center">${medal}</span>
          <div class="flex-1 rounded-xl bg-gray-100 overflow-hidden" style="height:3.5rem">
            <div class="standing-bar-end" style="background:${color(p.pid)};width:${isVisible ? Math.max(30, (p.total / maxScore) * 100) : '0'}%">
              <span class="font-bold text-white px-3">${p.name}</span>
            </div>
          </div>
          <span class="font-black text-2xl" style="width:4.5rem;text-align:right;padding-right:0.5rem;color:${color(p.pid)}">${p.total}</span>
        </div>`;
      }).join('');

      // Game stats
      const duration = S.finishedGame.dur ? `${S.finishedGame.dur} min` : 'N/A';
      const avgScore = Math.round(players.reduce((sum, p) => sum + p.total, 0) / players.length);
      const statsOpacity = S.revealComplete ? '1' : '0';

      return `<div style="min-height:100vh;background:var(--bg);position:relative;overflow:hidden" onclick="${isRevealing ? 'skipReveal()' : ''}">
        <canvas id="fireworks-canvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:1"></canvas>

        <div style="position:relative;z-index:2;padding-bottom:2rem">
          <div class="header-gradient text-white p-6 text-center" style="padding-top:3rem;padding-bottom:3rem">
            <div style="min-height:5rem;display:flex;flex-direction:column;align-items:center;justify-content:center">
              <div style="opacity:${isRevealing ? '1' : '0'};transition:opacity 0.3s">
                <div class="text-2xl text-white animate-pulse" style="opacity:0.7">Revealing...</div>
              </div>
              <div style="opacity:${winnerOpacity};transition:opacity 0.8s ease-in;${isRevealing ? 'position:absolute;' : ''}">
                ${winnerSection}
              </div>
            </div>
            ${isRevealing ? '<p class="text-sm text-white mt-3" style="opacity:0.7">Tap to skip</p>' : ''}
          </div>

          <div class="p-4" style="max-width:28rem;margin:0 auto">
            <div class="card p-4 mb-4" style="background:linear-gradient(135deg, var(--surface) 0%, var(--surface2) 100%)">
              <h3 class="font-bold mb-4" style="color:var(--accent)">üìä FINAL STANDINGS</h3>
              ${standings}
            </div>

            <div class="card p-4 mb-4" style="opacity:${statsOpacity};transition:opacity 1s ease-in 0.3s">
              <h3 class="font-bold mb-4" style="color:var(--accent)">üìà Game Stats</h3>
              <div class="flex justify-between text-center">
                <div>
                  <div class="text-2xl font-black" style="color:var(--accent)">${players.length}</div>
                  <div class="text-xs text-gray-500">Players</div>
                </div>
                <div>
                  <div class="text-2xl font-black" style="color:var(--accent)">${maxScore}</div>
                  <div class="text-xs text-gray-500">High Score</div>
                </div>
                <div>
                  <div class="text-2xl font-black" style="color:var(--accent)">${avgScore}</div>
                  <div class="text-xs text-gray-500">Avg Score</div>
                </div>
                <div>
                  <div class="text-2xl font-black" style="color:var(--accent)">${duration}</div>
                  <div class="text-xs text-gray-500">Duration</div>
                </div>
              </div>
            </div>

            <button class="btn btn-primary w-full" style="padding:1rem;font-size:1.125rem;opacity:${statsOpacity};transition:opacity 1s ease-in 0.5s" onclick="event.stopPropagation();saveAndExit()">
              Continue to Home üè†
            </button>
          </div>
        </div>
      </div>`;
    }

    function skipReveal() {
      if (S.revealComplete) return;
      S.revealComplete = true;
      S.revealIndex = S.finishedGame.players.length - 1;
      R();
    }

    function animateReveal() {
      if (!S.finishedGame || S.revealComplete) return;

      const totalPlayers = S.finishedGame.players.length;
      // Slower reveal: 600ms per player, or spread across 3 seconds max
      const delayPerPlayer = Math.max(600, Math.min(1000, 3000 / totalPlayers));

      function revealNext() {
        if (S.revealComplete || S.view !== 'endScreen') return;

        S.revealIndex++;

        if (S.revealIndex >= totalPlayers - 1) {
          // Final reveal - show winner
          setTimeout(() => {
            if (S.view === 'endScreen') {
              S.revealComplete = true;
              // Extra haptic for winner reveal
              if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200]);
              }
              R();
            }
          }, 400); // Pause before showing winner
          R();
          return;
        }

        R();

        if (!S.revealComplete) {
          setTimeout(revealNext, delayPerPlayer);
        }
      }

      // Start the reveal sequence
      setTimeout(revealNext, 800); // Longer initial delay
    }

    function startFireworks() {
      const canvas = document.getElementById('fireworks-canvas');
      if (!canvas) return;

      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const particles = [];
      const particleCount = 100;
      const gravity = 0.05;
      const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f7dc6f', '#bb8fce', '#85c1e2', '#ff8b94'];

      class Particle {
        constructor(x, y, color) {
          this.x = x;
          this.y = y;
          this.color = color;
          const angle = Math.random() * Math.PI * 2;
          const speed = Math.random() * 6 + 2;
          this.vx = Math.cos(angle) * speed;
          this.vy = Math.sin(angle) * speed;
          this.alpha = 1;
          this.decay = Math.random() * 0.015 + 0.015;
          this.size = Math.random() * 3 + 2;
        }

        update() {
          this.x += this.vx;
          this.y += this.vy;
          this.vy += gravity;
          this.alpha -= this.decay;
        }

        draw() {
          ctx.save();
          ctx.globalAlpha = this.alpha;
          ctx.fillStyle = this.color;
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
          ctx.fill();
          ctx.restore();
        }
      }

      function createFirework() {
        const x = Math.random() * canvas.width;
        const y = Math.random() * canvas.height * 0.5 + 50;
        const color = colors[Math.floor(Math.random() * colors.length)];

        for (let i = 0; i < particleCount; i++) {
          particles.push(new Particle(x, y, color));
        }
      }

      function animate() {
        ctx.fillStyle = 'rgba(0, 0, 0, 0.1)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        for (let i = particles.length - 1; i >= 0; i--) {
          particles[i].update();
          particles[i].draw();

          if (particles[i].alpha <= 0) {
            particles.splice(i, 1);
          }
        }

        if (S.view === 'endScreen') {
          requestAnimationFrame(animate);
        }
      }

      // Create initial fireworks
      for (let i = 0; i < 5; i++) {
        setTimeout(() => createFirework(), i * 200);
      }

      // Continue creating fireworks periodically
      const interval = setInterval(() => {
        if (S.view === 'endScreen') {
          createFirework();
        } else {
          clearInterval(interval);
        }
      }, 800);

      animate();
    }

    function addBonus() {
      if (S.game[S.cur].scores.yahtzee === 50) {
        S.game[S.cur].scores.bonus += 100;
        saveCurrentGame();
        R();
      }
    }

    function pauseG() {
      saveCurrentGame();
      S.game = [];
      S.cur = 0;
      showToast('Game paused & saved! ‚è∏Ô∏è');
      navigateTo('setup');
    }

    function saveG() {
      saveCurrentGame();
      showToast('Progress saved!');
    }
    
    function finishG() {
      // Check if game is actually complete
      if (isGameComplete()) {
        // Game is complete - show celebration modal
        S.finishModal = true;
      } else {
        // Game not complete - show early finish warning modal
        S.earlyFinishModal = true;
      }
      R();
    }

    function confirmFinish() {
      // Haptic feedback - vibrate for celebration
      if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100, 50, 200]); // Short celebration pattern
      }

      // Create game record with final scores
      S.finishedGame = {
        id: Date.now(),
        date: new Date().toISOString(),
        dur: S.start ? Math.round((Date.now() - S.start) / 60000) : null,
        players: S.game.map(p => ({pid: p.id, name: p.name, scores: {...p.scores}, total: grand(p.scores)}))
      };

      // Initialize reveal state
      S.revealIndex = -1; // Start before first player
      S.revealComplete = false;
      S.finishModal = false;

      // Navigate to end screen
      navigateTo('endScreen');
    }

    function saveAndExit() {
      // Save the finished game to history
      if (S.finishedGame) {
        S.history.unshift(S.finishedGame);
        save();
        S.finishedGame = null;
      }
      clearSavedGame();
      S.game = [];
      S.cur = 0;
      navigateTo('setup');
    }

    // Initialize history state
    history.replaceState({ view: S.view }, '', '#' + S.view);
    R();

    // Load and display version
    fetch('version.json')
      .then(res => res.json())
      .then(data => {
        const versionEl = document.getElementById('version');
        if (versionEl) {
          versionEl.textContent = `v${data.version} (${data.commit})`;
        }
      })
      .catch(() => {
        // Fallback if version.json doesn't load
        const versionEl = document.getElementById('version');
        if (versionEl) {
          versionEl.textContent = 'v1.0.0';
        }
      });

    // Register service worker for PWA with update detection
    if ('serviceWorker' in navigator) {
      let refreshing = false;

      // Reload page when new service worker takes over
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        if (!refreshing) {
          refreshing = true;
          window.location.reload();
        }
      });

      navigator.serviceWorker.register('sw.js').then(reg => {
        // Check for updates periodically
        setInterval(() => {
          reg.update();
        }, 60000); // Check every minute

        // Handle updates
        reg.addEventListener('updatefound', () => {
          const newWorker = reg.installing;
          newWorker.addEventListener('statechange', () => {
            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
              // New service worker available, show update prompt
              showUpdatePrompt();
            }
          });
        });
      }).catch(err => console.log('SW registration failed:', err));
    }

    function showUpdatePrompt() {
      const banner = document.createElement('div');
      banner.style.cssText = 'position:fixed;top:0;left:0;right:0;background:var(--accent);color:var(--text);padding:1rem;text-align:center;z-index:1000;box-shadow:0 2px 8px rgba(0,0,0,0.3);border-bottom:1px solid var(--accentDark);';
      banner.innerHTML = '<div style="max-width:28rem;margin:0 auto;"><strong>üéâ Update Available!</strong><br><small>A new version is ready. Your data is safe.</small><br><button style="margin-top:0.5rem;background:var(--text);color:var(--bg);border:none;padding:0.5rem 1.5rem;border-radius:0.5rem;font-weight:bold;cursor:pointer;" onclick="window.location.reload()">Update Now</button> <button style="margin-top:0.5rem;background:transparent;color:var(--text);border:1px solid var(--text);padding:0.5rem 1rem;border-radius:0.5rem;cursor:pointer;" onclick="this.parentElement.parentElement.remove()">Later</button></div>';
      document.body.appendChild(banner);
    }
  </script>
</body>
</html>
